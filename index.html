<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editor DTF - Montaje para Impresi√≥n</title>

  <!-- Librer√≠as -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <!-- ONNX Runtime Web para IA -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js" defer></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif }
    body { background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%); color:#2d3748; line-height:1.6; min-height:100vh; padding:20px }
    .container{ max-width:1400px; margin:0 auto; background:#fff; border-radius:15px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.1)}
    header{ background:linear-gradient(135deg,#2c3e50 0%,#4a5568 100%); color:#fff; padding:1.5rem 2rem; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap}
    .logo{ font-size:1.8rem; font-weight:700}
    .logo span{ color:#4299e1}
    .specs{ background:#4a5568; color:#fff; padding:.8rem 1.5rem; border-radius:8px; font-size:.9rem}
    .main-content{ display:flex; padding:1rem; gap:1.5rem; min-height:70vh }
    .toolbar,.controls{ width:250px; background:#f8f9fa; border-radius:10px; padding:1.5rem; box-shadow:0 4px 6px rgba(0,0,0,.05)}
    .tool-section{ margin-bottom:1.5rem; padding-bottom:1.5rem; border-bottom:1px solid #e9ecef}
    .tool-section:last-child{ border-bottom:none}
    .tool-section h3{ margin-bottom:1rem; color:#2d3748; font-size:1.1rem}
    .btn{ display:block; width:100%; padding:.8rem; margin-bottom:.8rem; border:none; border-radius:6px; background:#4299e1; color:#fff; font-weight:500; cursor:pointer; transition:background .3s; text-align:center}
    .btn:hover{ background:#3182ce}
    .btn-upload{ background:#48bb78}
    .btn-upload:hover{ background:#38a169}
    .btn-download{ background:#9f7aea}
    .btn-download:hover{ background:#805ad5}
    .btn-clear{ background:#f56565}
    .btn-clear:hover{ background:#e53e3e}
    .canvas-container{ flex:1; background:#f8f9fa; border-radius:10px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,.05); padding:1rem; display:flex; flex-direction:column}
    .canvas-title{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem}
    .canvas-area{ flex:1; background:#fff; border-radius:8px; overflow:auto; display:flex; justify-content:center; align-items:flex-start; padding:1rem; box-shadow:inset 0 0 10px rgba(0,0,0,.05); position:relative}
    #canvas{ background:#fff; box-shadow:0 0 20px rgba(0,0,0,.1); touch-action:none; cursor:default}
    .control-group{ margin-bottom:1.5rem}
    .control-group h4{ margin-bottom:.8rem; color:#2d3748}
    .slider-container{ display:flex; align-items:center; gap:10px; margin-bottom:1rem}
    .slider-container span{ min-width:40px; text-align:center}
    input[type="range"], input[type="number"], select{ width:100%}
    .row{ display:flex; gap:10px; align-items:center }
    .row > * { flex:1 }
    .size-controls{ display:flex; gap:10px; margin-bottom:1rem}
    .size-input{ flex:1}
    .size-input input{ width:100%; padding:.5rem; border:1px solid #cbd5e0; border-radius:4px; text-align:center}
    .size-info{ background:#edf2f7; padding:.8rem; border-radius:6px; margin-top:1rem; font-size:.9rem}
    .size-info h4{ margin-bottom:.5rem; color:#2d3748}
    .help-section{ margin-top:2rem; padding:1rem; background:#edf2f7; border-radius:8px}
    footer{ text-align:center; padding:1.5rem; background:#2d3748; color:#fff; margin-top:2rem }
    .instructions{ margin-top:1.5rem; padding:1.5rem; background:#edf2f7; border-radius:10px}
    .instructions h3{ margin-bottom:1rem; color:#2d3748}
    .instructions ol{ padding-left:1.5rem}
    .instructions li{ margin-bottom:.8rem}
    .designs-list{ max-height:200px; overflow-y:auto; margin-top:1rem; border:1px solid #e2e8f0; border-radius:6px; padding:.5rem}
    .design-item{ display:flex; align-items:center; padding:.5rem; margin-bottom:.5rem; background:#fff; border-radius:4px; cursor:pointer; transition:background .2s}
    .design-item:hover{ background:#edf2f7}
    .design-item.active{ background:#ebf8ff; border:1px solid #90cdf4}
    .design-thumb{ width:40px; height:40px; object-fit:cover; border-radius:3px; margin-right:.5rem}
    .proportion-lock{ display:flex; align-items:center; margin-bottom:1rem}
    .proportion-lock input{ margin-right:.5rem}
    .quality-options{ margin-top:1rem}
    .quality-options label{ display:block; margin-bottom:.5rem}
    .quality-options select{ width:100%; padding:.5rem; border:1px solid #cbd5e0; border-radius:4px}
    .canvas-background{ display:flex; align-items:center; gap:10px; margin-bottom:1rem}
    .canvas-background label{ white-space:nowrap}
    .canvas-background input{ width:30px; height:30px; padding:0; border:1px solid #cbd5e0; border-radius:4px; cursor:pointer}
    .message-container{ position:fixed; top:20px; right:20px; z-index:1000; max-width:350px}
    .message{ padding:12px 16px; margin-bottom:10px; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,.15); animation:slideIn .3s ease-out; display:flex; align-items:center}
    .message.info{ background:#bee3f8; color:#2c5282; border-left:4px solid #2c5282}
    .message.success{ background:#c6f6d5; color:#22543d; border-left:4px solid #22543d}
    .message.error{ background:#fed7d7; color:#742a2a; border-left:4px solid #742a2a}
    .message.warning{ background:#feebcb; color:#744210; border-left:4px solid #744210}
    .message.loading{ background:#e9d8fd; color:#553c9a; border-left:4px solid #553c9a}
    .message-icon{ margin-right:10px; font-size:18px}
    .close-message{ margin-left:auto; background:none; border:none; font-size:18px; cursor:pointer; opacity:.7}
    .close-message:hover{ opacity:1}
    @keyframes slideIn{ from{ transform:translateX(100%); opacity:0 } to{ transform:translateX(0); opacity:1 } }
    @keyframes slideOut{ from{ transform:translateX(0); opacity:1 } to{ transform:translateX(100%); opacity:0 } }
    @media (max-width:1024px){ .main-content{ flex-wrap:wrap } .toolbar,.controls{ width:100% } .message-container{ top:10px; right:10px; left:10px; max-width:none } }

    /* Overlay de contrase√±a */
    .lock-overlay{
      position:fixed; inset:0; background:linear-gradient(135deg,#2c3e50 0%,#4a5568 100%);
      display:flex; align-items:center; justify-content:center; z-index:2000; color:#fff
    }
    .lock-card{ background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.25);
      backdrop-filter: blur(10px); padding:2rem; border-radius:12px; width:min(90vw,380px) }
    .lock-card h2{ margin-bottom:1rem }
    .lock-card input{ width:100%; padding:.8rem; border-radius:8px; border:none; margin:.5rem 0 1rem 0 }
    .lock-card button{ width:100%; padding:.8rem; border:none; border-radius:8px; background:#48bb78; color:#fff; font-weight:600; cursor:pointer }
    .lock-error{ color:#fed7d7; min-height:1.2em; margin-bottom:.5rem }
  </style>
</head>
<body>
  <!-- Overlay de contrase√±a -->
  <div class="lock-overlay" id="lock-overlay" style="display:none;">
    <div class="lock-card">
      <h2>Acceso restringido</h2>
      <p>Ingresa la contrase√±a para ver el editor.</p>
      <input type="password" id="lock-pass" placeholder="Contrase√±a" autocomplete="current-password">
      <div class="lock-error" id="lock-error"></div>
      <button id="lock-btn">Acceder</button>
    </div>
  </div>

  <div class="container" id="app-root" style="visibility:hidden;">
    <header>
      <div class="logo">Editor DTF <span>By: David Munive</span></div>
      <div class="specs" id="specs-label">Lienzo: 58cm √ó 100cm | Formato: PNG/PDF</div>
    </header>

    <div class="main-content">
      <div class="toolbar">
        <div class="tool-section">
          <h3>Gesti√≥n de Dise√±os</h3>
          <input type="file" id="file-input" accept="image/*" style="display:none" multiple>
          <button class="btn btn-upload" id="upload-btn">‚¨ÜÔ∏è Subir Dise√±o(s)</button>
          <button class="btn" id="add-text-btn">‚úèÔ∏è Agregar Texto</button>

          <div class="canvas-background">
            <label for="canvas-color">Color de fondo:</label>
            <input type="color" id="canvas-color" value="#ffffff">
          </div>

          <div class="designs-list" id="designs-list">
            <div class="no-designs">No hay dise√±os cargados</div>
          </div>
        </div>

        <div class="tool-section">
          <h3>Opciones de Exportaci√≥n</h3>
          <div class="quality-options">
            <label for="quality-select">Resoluci√≥n de exportaci√≥n:</label>
            <select id="quality-select">
              <option value="300">Alta (300 DPI)</option>
              <option value="150" selected>Media (150 DPI)</option>
              <option value="72">Baja (72 DPI)</option>
            </select>
          </div>
          <button class="btn btn-download" id="download-png">üíæ Descargar PNG</button>
          <button class="btn btn-download" id="download-pdf">üìÑ Descargar PDF</button>
          <button class="btn btn-clear" id="clear-btn">üßπ Limpiar Lienzo</button>
        </div>

        <div class="instructions">
          <h3>Instrucciones</h3>
          <ol>
            <li>Sube tus dise√±os con el bot√≥n "Subir Dise√±o"</li>
            <li>Selecciona un dise√±o de la lista para editarlo</li>
            <li>Arrastra para mover, usa los controles para redimensionar y rotar</li>
            <li>Las dimensiones se muestran en cent√≠metros</li>
            <li>Descarga tu montaje en PNG o PDF</li>
          </ol>
          <p class="help-section">
            <strong>Nota:</strong> El color de fondo es solo para visualizaci√≥n.
            Las exportaciones mantendr√°n la transparencia.
          </p>
        </div>
      </div>

      <div class="canvas-container">
        <div class="canvas-title">
          <h3>√Årea de Montaje (<span id="canvas-size-label">58cm √ó 100cm</span>)</h3>
          <div id="zoom-level">Zoom: 100%</div>
        </div>
        <div class="canvas-area">
          <div class="canvas-wrapper" id="canvas-wrapper" style="width:580px;height:1000px;
            background-image:
              linear-gradient(45deg,#f0f0f0 25%,transparent 25%),
              linear-gradient(-45deg,#f0f0f0 25%,transparent 25%),
              linear-gradient(45deg,transparent 75%,#f0f0f0 75%),
              linear-gradient(-45deg,transparent 75%,#f0f0f0 75%);
            background-size:20px 20px;
            background-position:0 0,0 10px,10px -10px,-10px 0px;">
            <canvas id="canvas" width="580" height="1000"></canvas>
          </div>
        </div>
      </div>

      <div class="controls">
        <!-- 1) Alto del lienzo -->
        <div class="control-group">
          <h4>Alto del lienzo (cm)</h4>
          <div class="row">
            <input type="number" id="canvas-height-cm" min="10" max="100" step="0.5" value="100" title="Alto en cm (m√°x. 100)">
            <button class="btn" id="apply-canvas-height">Aplicar alto</button>
          </div>
          <small>El ancho permanece en 58 cm. M√°ximo 100 cm de alto.</small>
        </div>

        <!-- 2) Zoom del lienzo -->
        <div class="control-group">
          <h4>Zoom del Lienzo</h4>
          <div class="slider-container">
            <span id="zoom-value">100%</span>
            <input type="range" id="zoom-slider" min="20" max="200" value="100">
          </div>
        </div>

        <!-- 3) IA: Quitar fondo -->
        <div class="tool-section">
          <h3>Quitar fondo (IA)</h3>
          <div class="control-group">
            <div class="row">
              <select id="ia-backend" title="Motor de ejecuci√≥n">
                <option value="webgl">Acelerado (WebGL)</option>
                <option value="wasm">Compatible (WASM)</option>
              </select>
              <input type="number" id="ia-feather" value="3" min="0" max="20" step="1" title="Suavizado borde (px)" />
            </div>
            <small>Usa WebGL si tu navegador lo permite. ‚ÄúFeather‚Äù suaviza el borde.</small>
          </div>
          <div class="control-group">
            <button class="btn btn-download" id="ia-remove-bg">ü™Ñ Quitar fondo con IA</button>
          </div>
        </div>

        <!-- 4) Controles de dise√±o -->
        <div class="tool-section">
          <h3>Controles de Dise√±o</h3>

          <div class="control-group">
            <h4>Rotaci√≥n</h4>
            <div class="row">
              <div>
                <div class="slider-container">
                  <span id="rotation-value">0¬∞</span>
                  <input type="range" id="rotation-slider" min="0" max="360" value="0">
                </div>
              </div>
              <input type="number" id="rotation-input" min="0" max="360" step="1" value="0" title="Rotaci√≥n (¬∞)">
            </div>
          </div>

          <div class="control-group">
            <h4>Opacidad</h4>
            <div class="slider-container">
              <span id="opacity-value">100%</span>
              <input type="range" id="opacity-slider" min="10" max="100" value="100">
            </div>
          </div>

          <div class="control-group">
            <h4>Tama√±o Manual (cm)</h4>
            <div class="proportion-lock">
              <input type="checkbox" id="lock-proportion" checked>
              <label for="lock-proportion">Mantener proporci√≥n</label>
            </div>
            <div class="size-controls">
              <div class="size-input">
                <label>Ancho</label>
                <input type="number" id="width-input" min="1" step="0.1" value="0">
              </div>
              <div class="size-input">
                <label>Alto</label>
                <input type="number" id="height-input" min="1" step="0.1" value="0">
              </div>
            </div>
            <button class="btn" id="apply-size">Aplicar Tama√±o</button>
          </div>

          <div class="size-info">
            <h4>Dimensiones del dise√±o</h4>
            <div id="size-info">0cm √ó 0cm</div>
            <div id="original-size">Tama√±o original: 0cm √ó 0cm</div>
          </div>

          <button class="btn btn-clear" id="remove-btn">üóëÔ∏è Eliminar Dise√±o</button>
        </div>

        <div class="help-section">
          <h4>Atajos</h4>
          <p>‚Ä¢ Supr/Backspace: eliminar seleccionado</p>
          <p>‚Ä¢ Flechas: mover (Shift = 10 px)</p>
          <p>‚Ä¢ Ctrl/Cmd + D: duplicar seleccionado</p>
        </div>
      </div>
    </div>

    <footer>
      <p>Editor de Montajes para Impresi√≥n DTF</p>
    </footer>
  </div>

  <!-- Mensajes -->
  <div class="message-container" id="message-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      /* ======================= Seguridad (Contrase√±a) ======================= */
      const ACCESS_PASSWORD = 'dtf2025'; // <-- c√°mbiala aqu√≠
      const overlay = document.getElementById('lock-overlay');
      const appRoot = document.getElementById('app-root');
      const lockBtn = document.getElementById('lock-btn');
      const lockPass = document.getElementById('lock-pass');
      const lockError = document.getElementById('lock-error');

      function showLock(){ overlay.style.display = 'flex'; appRoot.style.visibility = 'hidden'; lockPass.focus(); }
      function unlock(){ overlay.style.display = 'none'; appRoot.style.visibility = 'visible'; }
      if (sessionStorage.getItem('dtf_unlocked') === '1') unlock(); else showLock();
      lockBtn.addEventListener('click', tryUnlock);
      lockPass.addEventListener('keydown', e => { if (e.key === 'Enter') tryUnlock(); });
      function tryUnlock(){
        if (lockPass.value === ACCESS_PASSWORD){
          sessionStorage.setItem('dtf_unlocked','1'); unlock();
        } else { lockError.textContent = 'Contrase√±a incorrecta'; }
      }

      /* ======================= Referencias DOM ======================= */
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const uploadBtn = document.getElementById('upload-btn');
      const fileInput = document.getElementById('file-input');
      const clearBtn = document.getElementById('clear-btn');
      const downloadPngBtn = document.getElementById('download-png');
      const downloadPdfBtn = document.getElementById('download-pdf');
      const rotationSlider = document.getElementById('rotation-slider');
      const rotationValue = document.getElementById('rotation-value');
      const rotationInput = document.getElementById('rotation-input');
      const opacitySlider = document.getElementById('opacity-slider');
      const opacityValue = document.getElementById('opacity-value');
      const zoomSlider = document.getElementById('zoom-slider');
      const zoomValue = document.getElementById('zoom-value');
      const zoomLevel = document.getElementById('zoom-level');
      const addTextBtn = document.getElementById('add-text-btn');
      const designsList = document.getElementById('designs-list');
      const removeBtn = document.getElementById('remove-btn');
      const sizeInfo = document.getElementById('size-info');
      const originalSizeInfo = document.getElementById('original-size');
      const widthInput = document.getElementById('width-input');
      const heightInput = document.getElementById('height-input');
      const applySizeBtn = document.getElementById('apply-size');
      const lockProportion = document.getElementById('lock-proportion');
      const qualitySelect = document.getElementById('quality-select');
      const canvasColor = document.getElementById('canvas-color');
      const messageContainer = document.getElementById('message-container');
      const canvasWrapper = document.getElementById('canvas-wrapper');
      const specsLabel = document.getElementById('specs-label');
      const canvasSizeLabel = document.getElementById('canvas-size-label');
      const canvasHeightInput = document.getElementById('canvas-height-cm');
      const applyCanvasHeightBtn = document.getElementById('apply-canvas-height');
      const iaBtn = document.getElementById('ia-remove-bg');
      const iaBackendSel = document.getElementById('ia-backend');
      const iaFeatherInput = document.getElementById('ia-feather');

      /* ======================= Constantes f√≠sicas ======================= */
      const PIXELS_PER_CM = 10; // 10 px = 1 cm (580px/58cm)
      const CANVAS_WIDTH_CM = 58; // fijo
      let CANVAS_HEIGHT_CM = 100; // variable (m√°x 100)
      const INCHES_PER_CM = 0.3937007874;

      /* ======================= Estado ======================= */
      let designs = [];
      let selectedDesignId = null;
      let isDragging = false, isResizing = false, isRotating = false;
      let dragOffsetX, dragOffsetY, canvasZoom = 1.0;
      let lastMouseX, lastMouseY, startScale = 1.0, startResizeDist = 1.0;
      let canvasBackgroundColor = '#ffffff';

      /* ======================= Mensajes ======================= */
      function showMessage(message, type = 'info', duration = 5000) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        const icons = { info:'‚ÑπÔ∏è', success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', loading:'‚è≥' };
        messageEl.innerHTML = `
          <span class="message-icon">${icons[type] || icons.info}</span>
          <span>${message}</span>
          <button class="close-message">&times;</button>`;
        messageContainer.appendChild(messageEl);
        messageEl.querySelector('.close-message').addEventListener('click', close);
        function close(){ messageEl.style.animation='slideOut .3s ease-out'; setTimeout(()=> messageEl.remove(), 300); }
        if (duration>0) setTimeout(()=> messageEl && close(), duration);
        return messageEl;
      }

      /* ======================= Fondo y gu√≠a ======================= */
      function initCanvas() {
        ctx.save();
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const size = 20;
        ctx.fillStyle = '#f0f0f0';
        for (let y = 0; y < canvas.height; y += size) {
          for (let x = 0; x < canvas.width; x += size) {
            if (((x/size + y/size) % 2) === 0) ctx.fillRect(x, y, size, size);
          }
        }
        ctx.globalAlpha = 0.7;
        ctx.fillStyle = canvasBackgroundColor;
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.globalAlpha = 1.0;
        ctx.strokeStyle = '#cbd5e0';
        ctx.lineWidth = 2;
        ctx.setLineDash([5,5]);
        ctx.strokeRect(5,5, canvas.width-10, canvas.height-10);
        ctx.setLineDash([]);
        if (designs.length===0){
          ctx.fillStyle = '#e2e8f0';
          ctx.font = '20px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('BY: DAVID MUNIVE', canvas.width/2, canvas.height/2);
        }
        ctx.restore();
      }
      initCanvas();

      /* ======================= Clase Design ======================= */
      class Design {
        constructor(id, image, x, y) {
          this.id = id;
          this.image = image;
          this.x = x || canvas.width/2;
          this.y = y || canvas.height/2;
          this.scale = 1.0;
          this.rotation = 0;
          this.opacity = 1.0;
          this.width = image.width;
          this.height = image.height;
          this.aspectRatio = image.width / image.height;
          this.originalWidth = image.width;
          this.originalHeight = image.height;
        }
        draw() {
          ctx.save();
          ctx.globalAlpha = this.opacity;
          ctx.translate(this.x, this.y);
          ctx.rotate(this.rotation * Math.PI / 180);
          ctx.scale(this.scale, this.scale);
          const width = this.width, height = this.height;
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(this.image, -width/2, -height/2, width, height);
          if (this.id === selectedDesignId) {
            ctx.strokeStyle = '#4299e1'; ctx.lineWidth = 2;
            ctx.strokeRect(-width/2, -height/2, width, height);
            ctx.fillStyle = '#4299e1'; ctx.beginPath(); ctx.arc(0,0,4,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = '#48bb78'; ctx.beginPath(); ctx.arc(0, -height/2 - 15, 6, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#f56565'; ctx.beginPath(); ctx.arc(width/2 + 5, height/2 + 5, 6, 0, Math.PI*2); ctx.fill();
          }
          ctx.restore();
        }
        getDimensionsInCm(){ return { width:(this.width*this.scale)/PIXELS_PER_CM, height:(this.height*this.scale)/PIXELS_PER_CM }; }
        getOriginalDimensionsInCm(){ return { width:(this.originalWidth)/PIXELS_PER_CM, height:(this.originalHeight)/PIXELS_PER_CM }; }
        setDimensions(widthCm, heightCm, keep = true){
          const targetW = widthCm*PIXELS_PER_CM, targetH = heightCm*PIXELS_PER_CM;
          if (keep) { this.scale = targetW / this.originalWidth; }
          else { const sx = targetW/this.originalWidth, sy = targetH/this.originalHeight; this.scale = (sx+sy)/2; }
          this.updateInputs(); drawCanvas();
        }
        updateInputs(){ const d = this.getDimensionsInCm(); widthInput.value = d.width.toFixed(1); heightInput.value = d.height.toFixed(1); }
        isPointInside(x,y){
          const w = this.width*this.scale, h = this.height*this.scale;
          const relX = x - this.x, relY = y - this.y, ang = -this.rotation*Math.PI/180;
          const rx = relX*Math.cos(ang) - relY*Math.sin(ang), ry = relX*Math.sin(ang)+relY*Math.cos(ang);
          return Math.abs(rx) <= w/2 && Math.abs(ry) <= h/2;
        }
        isRotationHandle(x,y){
          const w = this.width*this.scale, h = this.height*this.scale;
          const relX = x - this.x, relY = y - this.y, ang = -this.rotation*Math.PI/180;
          const rx = relX*Math.cos(ang) - relY*Math.sin(ang), ry = relX*Math.sin(ang)+relY*Math.cos(ang);
          return Math.hypot(rx-0, ry-(-h/2-15)) <= 10;
        }
        isScaleHandle(x,y){
          const w = this.width*this.scale, h = this.height*this.scale;
          const relX = x - this.x, relY = y - this.y, ang = -this.rotation*Math.PI/180;
          const rx = relX*Math.cos(ang) - relY*Math.sin(ang), ry = relX*Math.sin(ang)+relY*Math.cos(ang);
          return Math.hypot(rx-(w/2+5), ry-(h/2+5)) <= 10;
        }
      }

      /* ======================= Dibujo general ======================= */
      function drawCanvas(){ initCanvas(); designs.forEach(d=>d.draw()); updateSizeInfo(); }
      function updateSizeInfo(){
        const d = getSelectedDesign();
        if (d){ const c = d.getDimensionsInCm(), o = d.getOriginalDimensionsInCm();
          sizeInfo.textContent = `${c.width.toFixed(1)}cm √ó ${c.height.toFixed(1)}cm`;
          originalSizeInfo.textContent = `Tama√±o original: ${o.width.toFixed(1)}cm √ó ${o.height.toFixed(1)}cm`;
        } else { sizeInfo.textContent = '0cm √ó 0cm'; originalSizeInfo.textContent = 'Tama√±o original: 0cm √ó 0cm'; }
      }

      /* ======================= Exportaci√≥n ======================= */
      function getPixelDimensions(dpi){
        return {
          width:  Math.round(CANVAS_WIDTH_CM  * INCHES_PER_CM * dpi),
          height: Math.round(CANVAS_HEIGHT_CM * INCHES_PER_CM * dpi)
        };
      }
      function createHighQualityCanvas(){
        const dpi = parseInt(qualitySelect.value);
        const dim = getPixelDimensions(dpi);
        const out = document.createElement('canvas');
        out.width = dim.width; out.height = dim.height;
        const ectx = out.getContext('2d');
        ectx.imageSmoothingEnabled = true; ectx.imageSmoothingQuality = 'high';
        const sx = out.width/canvas.width, sy = out.height/canvas.height;
        ectx.clearRect(0,0,out.width,out.height);
        designs.forEach(d=>{
          ectx.save(); ectx.globalAlpha = d.opacity;
          const x = d.x * sx, y = d.y * sy, sc = d.scale * Math.min(sx, sy);
          ectx.translate(x, y); ectx.rotate(d.rotation*Math.PI/180); ectx.scale(sc, sc);
          ectx.drawImage(d.image, -d.width/2, -d.height/2, d.width, d.height);
          ectx.restore();
        });
        return out;
      }

      /* ======================= Fondo (visual) ======================= */
      canvasColor.addEventListener('input', function(){ canvasBackgroundColor = this.value; drawCanvas(); showMessage(`Color de fondo cambiado a ${this.value}`, 'info', 2000); });

      /* ======================= Upload (re-subir + auto-fit) ======================= */
      uploadBtn.addEventListener('click', ()=>{ fileInput.value = ''; fileInput.click(); });
      fileInput.addEventListener('change', function(e){
        if (!e.target.files || !e.target.files.length) return;
        const files = Array.from(e.target.files);
        let loaded = 0; const total = files.length;
        const loadingMsg = showMessage(`Cargando ${total} dise√±o(s)...`,'loading',0);

        files.forEach(file=>{
          if (!file.type.match('image.*')){ showMessage(`Error: ${file.name} no es imagen`,'error'); if (++loaded===total) loadingMsg.remove(); return; }
          const reader = new FileReader();
          reader.onload = ev=>{
            const img = new Image();
            img.onload = ()=>{
              const id = 'design-' + Date.now() + Math.random().toString(36).slice(2,7);
              const d = new Design(id, img);
              const maxW = canvas.width - 20, maxH = canvas.height - 20;
              const fit = Math.min(maxW/d.width, maxH/d.height);
              d.scale = Math.min(1, fit);
              designs.push(d); selectedDesignId = id;
              if (++loaded===total){ loadingMsg.remove(); showMessage(`${total} dise√±o(s) cargado(s)`,'success'); }
              updateDesignsList(); updateControls(); drawCanvas();
            };
            img.onerror = ()=>{ if (++loaded===total) loadingMsg.remove(); showMessage(`Error al cargar: ${file.name}`,'error'); };
            img.src = ev.target.result;
          };
          reader.onerror = ()=>{ if (++loaded===total) loadingMsg.remove(); showMessage(`Error al leer: ${file.name}`,'error'); };
          reader.readAsDataURL(file);
        });

        fileInput.value = ''; // permite re-subir el mismo archivo
      });

      /* ======================= Lista ======================= */
      function updateDesignsList(){
        designsList.innerHTML = '';
        if (!designs.length){ designsList.innerHTML = '<div class="no-designs">No hay dise√±os cargados</div>'; return; }
        designs.forEach(design=>{
          const item = document.createElement('div');
          item.className = 'design-item' + (design.id===selectedDesignId ? ' active' : '');
          item.dataset.id = design.id;

          const thumb = document.createElement('canvas');
          thumb.width = 40; thumb.height = 40;
          const tc = thumb.getContext('2d');
          const s = Math.min(40/design.width, 40/design.height) * 0.8;
          tc.fillStyle = '#fff'; tc.fillRect(0,0,40,40);
          tc.save(); tc.translate(20,20); tc.scale(s,s);
          tc.drawImage(design.image, -design.width/2, -design.height/2, design.width, design.height);
          tc.restore(); tc.strokeStyle = '#cbd5e0'; tc.strokeRect(0,0,40,40);

          item.innerHTML = `<img class="design-thumb" src="${thumb.toDataURL('image/png')}" alt="Miniatura"><div>Dise√±o ${designs.indexOf(design)+1}</div>`;
          item.addEventListener('click', ()=>{ selectedDesignId = design.id; updateDesignsList(); updateControls(); drawCanvas(); showMessage(`Dise√±o ${designs.indexOf(design)+1} seleccionado`,'info',2000); });
          designsList.appendChild(item);
        });
      }

      /* ======================= Controles ======================= */
      function updateControls(){
        const d = getSelectedDesign();
        if (d){
          rotationSlider.value = Math.round(d.rotation);
          rotationInput.value = Math.round(d.rotation);
          rotationValue.textContent = Math.round(d.rotation) + '¬∞';
          opacitySlider.value = Math.round(d.opacity*100);
          opacityValue.textContent = Math.round(d.opacity*100) + '%';
          d.updateInputs();
          [rotationSlider, rotationInput, opacitySlider, removeBtn, widthInput, heightInput, applySizeBtn, lockProportion].forEach(el=> el.disabled=false);
          updateSizeInfo();
        } else {
          [rotationSlider, rotationInput, opacitySlider, removeBtn, widthInput, heightInput, applySizeBtn, lockProportion].forEach(el=> el.disabled=true);
          sizeInfo.textContent = '0cm √ó 0cm'; originalSizeInfo.textContent = 'Tama√±o original: 0cm √ó 0cm';
        }
      }
      function getSelectedDesign(){ return designs.find(d=> d.id===selectedDesignId); }

      applySizeBtn.addEventListener('click', function(){
        const d = getSelectedDesign(); if (!d) return;
        const w = parseFloat(widthInput.value), h = parseFloat(heightInput.value);
        if (!isNaN(w) && !isNaN(h) && w>0 && h>0){ d.setDimensions(w,h, lockProportion.checked); showMessage(`Tama√±o ajustado a ${w}cm √ó ${h}cm`, 'success', 2000); }
      });
      lockProportion.addEventListener('change', function(){
        const d = getSelectedDesign();
        if (d && this.checked){ const w = parseFloat(widthInput.value); if (!isNaN(w) && w>0) heightInput.value = (w/d.aspectRatio).toFixed(1); }
        showMessage(this.checked ? 'Proporci√≥n bloqueada' : 'Proporci√≥n desbloqueada','info',2000);
      });
      widthInput.addEventListener('input', function(){
        if (!lockProportion.checked) return; const d = getSelectedDesign(); if (!d) return;
        const w = parseFloat(this.value); if (!isNaN(w) && w>0) heightInput.value = (w/d.aspectRatio).toFixed(1);
      });
      heightInput.addEventListener('input', function(){
        if (!lockProportion.checked) return; const d = getSelectedDesign(); if (!d) return;
        const h = parseFloat(this.value); if (!isNaN(h) && h>0) widthInput.value = (h*d.aspectRatio).toFixed(1);
      });
      rotationSlider.addEventListener('input', function(){
        const d = getSelectedDesign(); if (!d) return;
        d.rotation = parseInt(this.value); rotationInput.value = this.value; rotationValue.textContent = this.value + '¬∞'; drawCanvas();
      });
      rotationInput.addEventListener('input', function(){
        const d = getSelectedDesign(); if (!d) return;
        let v = parseInt(this.value); if (isNaN(v)) v = 0; v = ((v%360)+360)%360;
        d.rotation = v; rotationSlider.value = v; rotationValue.textContent = v + '¬∞'; drawCanvas();
      });
      opacitySlider.addEventListener('input', function(){ const d = getSelectedDesign(); if (!d) return; d.opacity = this.value/100; opacityValue.textContent = this.value + '%'; drawCanvas(); });
      removeBtn.addEventListener('click', function(){ const d = getSelectedDesign(); if (!d) return;
        if (confirm('¬øEliminar este dise√±o?')){ designs = designs.filter(x=>x.id!==d.id); selectedDesignId = designs.length ? designs[designs.length-1].id : null; showMessage('Dise√±o eliminado','info',2000); updateDesignsList(); updateControls(); drawCanvas(); }
      });

      /* ======================= Zoom ======================= */
      zoomSlider.addEventListener('input', function(){
        canvasZoom = this.value/100; zoomValue.textContent = this.value + '%'; zoomLevel.textContent = 'Zoom: ' + this.value + '%';
        const area = document.querySelector('.canvas-area'); canvasWrapper.style.transform = `scale(${canvasZoom})`;
        area.scrollLeft = (canvas.width*canvasZoom - area.clientWidth)/2; area.scrollTop = (canvas.height*canvasZoom - area.clientHeight)/2;
      });

      /* ======================= Texto ======================= */
      addTextBtn.addEventListener('click', function(){
        const text = prompt('Ingresa el texto que deseas agregar:', 'Texto de ejemplo');
        if (!text) return;
        const t = document.createElement('canvas'); t.width = 600; t.height = 200;
        const tc = t.getContext('2d'); tc.clearRect(0,0,t.width,t.height);
        tc.fillStyle = '#000'; tc.font = '80px Arial'; tc.textAlign = 'center'; tc.textBaseline = 'middle'; tc.fillText(text, t.width/2, t.height/2);
        const img = new Image();
        img.onload = ()=>{ const id='text-'+Date.now(); const d=new Design(id, img, canvas.width/2, canvas.height/2);
          const maxW=canvas.width-20, maxH=canvas.height-20, fit=Math.min(maxW/d.width, maxH/d.height); d.scale = Math.min(1,fit);
          designs.push(d); selectedDesignId=id; showMessage('Texto agregado','success',2000); updateDesignsList(); updateControls(); drawCanvas(); };
        img.src = t.toDataURL('image/png');
      });

      /* ======================= Exportar ======================= */
      downloadPngBtn.addEventListener('click', function(){
        if (!designs.length){ showMessage('No hay dise√±os para exportar','error'); return; }
        const loading = showMessage('Preparando descarga PNG...','loading',0);
        setTimeout(()=>{ try{
          const ex = createHighQualityCanvas(); const a=document.createElement('a'); a.download='montaje-dtf.png';
          ex.toBlob(b=>{ a.href=URL.createObjectURL(b); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); loading.remove(); showMessage('Descarga PNG completada','success'); },100); }, 'image/png', 1.0);
        } catch(err){ loading.remove(); showMessage('Error al generar PNG: '+err.message,'error'); } }, 150);
      });
      downloadPdfBtn.addEventListener('click', function(){
        if (!designs.length){ showMessage('No hay dise√±os para exportar','error'); return; }
        const loading = showMessage('Preparando descarga PDF...','loading',0);
        setTimeout(()=>{ try{
          const ex = createHighQualityCanvas();
          ex.toBlob(b=>{
            const r = new FileReader();
            r.onload = function(){
              const imgData = r.result; const { jsPDF } = window.jspdf;
              const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:[CANVAS_WIDTH_CM*10, CANVAS_HEIGHT_CM*10] });
              doc.addImage(imgData, 'PNG', 0, 0, CANVAS_WIDTH_CM*10, CANVAS_HEIGHT_CM*10, undefined, 'FAST');
              doc.save('montaje-dtf.pdf'); loading.remove(); showMessage('Descarga PDF completada','success');
            }; r.readAsDataURL(b);
          }, 'image/png', 1.0);
        } catch(err){ loading.remove(); showMessage('Error al generar PDF: '+err.message,'error'); } }, 150);
      });

      /* ======================= Limpiar ======================= */
      clearBtn.addEventListener('click', function(){
        if (designs.length && confirm('¬øLimpiar el lienzo? Se perder√°n todos los dise√±os.')){
          designs = []; selectedDesignId = null; showMessage('Lienzo limpiado','info',2000); updateDesignsList(); updateControls(); initCanvas();
        }
      });

      /* ======================= Interacci√≥n mouse/touch ======================= */
      canvas.addEventListener('mousedown', function(e){
        const {x,y} = toCanvasCoords(e); lastMouseX=x; lastMouseY=y;
        for (let i=designs.length-1;i>=0;i--){
          const d=designs[i];
          if (d.isRotationHandle(x,y)){ selectedDesignId=d.id; isRotating=true; updateDesignsList(); updateControls(); drawCanvas(); return; }
          if (d.isScaleHandle(x,y)){ selectedDesignId=d.id; isResizing=true; startScale=d.scale; startResizeDist=Math.hypot(x-d.x,y-d.y); updateDesignsList(); updateControls(); drawCanvas(); return; }
          if (d.isPointInside(x,y)){ selectedDesignId=d.id; isDragging=true; dragOffsetX=x-d.x; dragOffsetY=y-d.y; updateDesignsList(); updateControls(); drawCanvas(); return; }
        }
        selectedDesignId=null; updateDesignsList(); updateControls(); drawCanvas();
      });
      canvas.addEventListener('mousemove', function(e){
        const {x,y} = toCanvasCoords(e); lastMouseX=x; lastMouseY=y; const d=getSelectedDesign(); if (!d) return;
        if (isDragging){ d.x=x-dragOffsetX; d.y=y-dragOffsetY; drawCanvas(); }
        else if (isRotating){ let a=Math.atan2(y-d.y, x-d.x)*180/Math.PI + 90; a=((a%360)+360)%360; d.rotation=a; rotationSlider.value=Math.round(a); rotationInput.value=Math.round(a); rotationValue.textContent=Math.round(a)+'¬∞'; drawCanvas(); }
        else if (isResizing){ const dist=Math.hypot(x-d.x,y-d.y), factor=dist/Math.max(1,startResizeDist); d.scale=startScale*factor; d.updateInputs(); updateSizeInfo(); drawCanvas(); }
      });
      ['mouseup','mouseleave'].forEach(ev=> canvas.addEventListener(ev, ()=>{ isDragging=false; isResizing=false; isRotating=false; }));

      canvas.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousedown',{clientX:t.clientX,clientY:t.clientY})); }, {passive:false});
      canvas.addEventListener('touchmove',  e=>{ e.preventDefault(); const t=e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousemove',{clientX:t.clientX,clientY:t.clientY})); }, {passive:false});
      canvas.addEventListener('touchend',   e=>{ e.preventDefault(); canvas.dispatchEvent(new MouseEvent('mouseup',{})); }, {passive:false});

      /* ======================= Alto del lienzo ======================= */
      applyCanvasHeightBtn.addEventListener('click', function(){
        let newH = parseFloat(canvasHeightInput.value); if (isNaN(newH)) return;
        newH = Math.max(10, Math.min(100, newH));
        CANVAS_HEIGHT_CM = newH;
        const newPx = Math.round(CANVAS_HEIGHT_CM * PIXELS_PER_CM);
        canvas.height = newPx; canvasWrapper.style.height = newPx + 'px';
        canvasSizeLabel.textContent = `${CANVAS_WIDTH_CM}cm √ó ${CANVAS_HEIGHT_CM}cm`;
        specsLabel.textContent = `Lienzo: ${CANVAS_WIDTH_CM}cm √ó ${CANVAS_HEIGHT_CM}cm | Formato: PNG/PDF`;
        drawCanvas(); showMessage(`Alto del lienzo ajustado a ${CANVAS_HEIGHT_CM} cm`, 'success', 2000);
      });

      /* ======================= Atajos ======================= */
      document.addEventListener('keydown', function(e){
        const tag = (e.target.tagName||'').toLowerCase();
        if (tag==='input' || tag==='textarea') return;
        const d = getSelectedDesign(), step = e.shiftKey ? 10 : 1;

        if ((e.key==='Delete' || e.key==='Backspace') && d){ e.preventDefault();
          designs = designs.filter(x=>x.id!==d.id); selectedDesignId = designs.length ? designs[designs.length-1].id : null;
          updateDesignsList(); updateControls(); drawCanvas(); showMessage('Dise√±o eliminado','info',1500); return; }

        if (!d) return;

        if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='d'){ e.preventDefault();
          const id='design-'+Date.now()+Math.random().toString(36).slice(2,7); const dup=new Design(id, d.image, d.x+10, d.y+10);
          dup.scale=d.scale; dup.rotation=d.rotation; dup.opacity=d.opacity; designs.push(dup); selectedDesignId=id;
          updateDesignsList(); updateControls(); drawCanvas(); showMessage('Dise√±o duplicado','success',1200); return; }

        if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
          e.preventDefault();
          if (e.key==='ArrowLeft') d.x-=step;
          if (e.key==='ArrowRight') d.x+=step;
          if (e.key==='ArrowUp') d.y-=step;
          if (e.key==='ArrowDown') d.y+=step;
          drawCanvas();
        }
      });

      function toCanvasCoords(e){
        const r = canvas.getBoundingClientRect();
        const sx = canvas.width / r.width, sy = canvas.height / r.height;
        return { x:(e.clientX - r.left)*sx, y:(e.clientY - r.top)*sy };
      }

      updateControls();
      setTimeout(()=> showMessage('¬°Bienvenido al Editor DTF! Sube tus dise√±os para comenzar.','info'), 800);

      /* ======================= IA: U¬≤-Netp (ONNX) - rutas robustas ======================= */

      // Detecta el path base real del sitio en GitHub Pages (root, /repo/, /docs/, subcarpetas)
      function detectBasePath() {
        const parts = location.pathname.split('/').filter(Boolean);
        const isGP = location.hostname.endsWith('github.io');
        if (!isGP) {
          // Dominio propio: usamos el directorio del documento publicado
          return location.pathname.replace(/[^/]+$/, '');
        }
        if (parts.length === 0) return '/';         // User/Org Pages
        // Project Pages ‚Üí primer segmento es el repo (/usuario.github.io/repo/)
        return `/${parts[0]}/`;
      }
      // Si tu app est√° dentro de otra subcarpeta adicional (ej: /repo/app/), ind√≠calo aqu√≠:
      const APP_SUBDIR = ''; // por ejemplo 'app/'

      const BASE = detectBasePath() + APP_SUBDIR;
      const U2NET_MODEL_PATH = new URL('models/u2netp.onnx', location.origin + BASE).href;

      let u2netSession = null, u2netLoading = false;

      async function waitForOrt(maxMs = 8000) {
        const t0 = performance.now();
        while (!window.ort) {
          if (performance.now() - t0 > maxMs) throw new Error('onnxruntime-web no carg√≥');
          await new Promise(r => setTimeout(r, 50));
        }
        return window.ort;
      }
      async function assertModelReachable() {
        const res = await fetch(U2NET_MODEL_PATH, { method:'HEAD', cache:'no-store' });
        if (!res.ok) throw new Error(`Modelo no accesible (${res.status}) en: ${U2NET_MODEL_PATH}`);
      }
      async function loadU2NetSessionPreferred(backend = 'webgl') {
        if (u2netSession) return u2netSession;
        if (u2netLoading) { while (u2netLoading) await new Promise(r => setTimeout(r,100)); return u2netSession; }
        u2netLoading = true;
        try {
          const ort = await waitForOrt();
          await assertModelReachable();
          async function create(EPs){ return await ort.InferenceSession.create(U2NET_MODEL_PATH, { executionProviders: EPs, graphOptimizationLevel: 'all' }); }
          try {
            const EPs = backend==='webgl' ? ['webgl','wasm'] : ['wasm'];
            u2netSession = await create(EPs);
          } catch(e){
            console.warn('[IA] Falla con', backend, '‚Üí probando WASM puro', e);
            u2netSession = await create(['wasm']);
          }
          return u2netSession;
        } finally { u2netLoading = false; }
      }
      function u2netPreprocess(image, target = 320) {
        const w = image.naturalWidth || image.width, h = image.naturalHeight || image.height;
        const s = Math.min(target/w, target/h);
        const nw = Math.max(1, Math.round(w*s)), nh = Math.max(1, Math.round(h*s));
        const ox = Math.floor((target-nw)/2), oy = Math.floor((target-nh)/2);
        const can = document.createElement('canvas'); can.width = target; can.height = target;
        const c = can.getContext('2d'); c.fillStyle='black'; c.fillRect(0,0,target,target);
        c.imageSmoothingEnabled=true; c.imageSmoothingQuality='high'; c.drawImage(image, ox, oy, nw, nh);
        const rgba = c.getImageData(0,0,target,target).data, f32 = new Float32Array(1*3*target*target);
        let p=0; for (let y=0;y<target;y++){ for (let x=0;x<target;x++){ const i=(y*target+x)*4; f32[p]=rgba[i]/255; f32[p+target*target]=rgba[i+1]/255; f32[p+2*target*target]=rgba[i+2]/255; p++; } }
        return { inputTensor: new ort.Tensor('float32', f32, [1,3,target,target]), letterbox:{offX:ox, offY:oy, newW:nw, newH:nh, target} };
      }
      function u2netPostprocess(out, design, letterbox, featherPx = 3) {
        if (!out?.data || !out?.dims) throw new Error('Salida del modelo inv√°lida');
        const w0=design.originalWidth, h0=design.originalHeight, H=out.dims[2], W=out.dims[3], pred=out.data;
        const small = document.createElement('canvas'); small.width=W; small.height=H;
        const sc=small.getContext('2d'); const img=sc.createImageData(W,H); let i=0;
        for (let y=0;y<H;y++){ for (let x=0;x<W;x++){ const v=Math.max(0,Math.min(1,pred[i++])); const a=Math.round(v*255); const idx=(y*W+x)*4; img.data[idx]=255; img.data[idx+1]=255; img.data[idx+2]=255; img.data[idx+3]=a; } }
        sc.putImageData(img,0,0);
        const full = document.createElement('canvas'); full.width=w0; full.height=h0; const fc=full.getContext('2d');
        fc.imageSmoothingEnabled=true; fc.imageSmoothingQuality='high';
        const {offX,offY,newW,newH} = letterbox;
        const src=document.createElement('canvas'); src.width=newW; src.height=newH; const sctx=src.getContext('2d');
        sctx.drawImage(small, offX, offY, newW, newH, 0, 0, newW, newH);
        const scaleBack = Math.max(w0/newW, h0/newH), dw=Math.round(newW*scaleBack), dh=Math.round(newH*scaleBack);
        const dx=Math.round((w0-dw)/2), dy=Math.round((h0-dh)/2);
        fc.clearRect(0,0,w0,h0); fc.drawImage(src, 0,0,newW,newH, dx,dy,dw,dh);
        if (featherPx>0){ fc.globalCompositeOperation='destination-in';
          const blur=document.createElement('canvas'); blur.width=w0; blur.height=h0; const bc=blur.getContext('2d');
          const f=Math.max(1, Math.min(8, Math.ceil(featherPx/2))), bw=Math.max(1,Math.floor(w0/f)), bh=Math.max(1,Math.floor(h0/f));
          bc.drawImage(full, 0,0,w0,h0, 0,0,bw,bh); fc.drawImage(blur, 0,0,bw,bh, 0,0,w0,h0); fc.globalCompositeOperation='source-over';
        }
        return full;
      }
      function applyMask(design, mask){
        const w=design.originalWidth, h=design.originalHeight, out=document.createElement('canvas'); out.width=w; out.height=h;
        const oc=out.getContext('2d'); oc.drawImage(design.image,0,0,w,h); oc.globalCompositeOperation='destination-in'; oc.drawImage(mask,0,0,w,h); oc.globalCompositeOperation='source-over';
        const img=new Image(); img.onload=()=>{ design.image=img; updateDesignsList(); drawCanvas(); }; img.src=out.toDataURL('image/png');
      }
      async function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

      iaBtn.addEventListener('click', async ()=>{
        const d = getSelectedDesign(); if (!d){ showMessage('Selecciona un dise√±o primero','warning',1800); return; }
        const backend = iaBackendSel.value || 'webgl'; const feather = parseInt(iaFeatherInput.value||'3',10);
        const msg = showMessage('Cargando modelo IA‚Ä¶','loading',0);
        try {
          const session = await loadU2NetSessionPreferred(backend);
          msg.innerHTML = msg.innerHTML.replace('Cargando modelo IA', 'Procesando imagen');
          const { inputTensor, letterbox } = u2netPreprocess(d.image, 320);
          const feeds = {}; const inName = session.inputNames?.[0]; if (!inName) throw new Error('El modelo no expone entradas'); feeds[inName] = inputTensor;
          const outMap = await session.run(feeds); const outName = session.outputNames?.[0]; if (!outName) throw new Error('El modelo no expone salidas');
          const out = outMap[outName]; const mask = u2netPostprocess(out, d, letterbox, feather); applyMask(d, mask);
          msg.remove(); showMessage('Fondo eliminado con IA','success',1500);
        } catch (err) {
          console.error('[IA] Error:', err); msg.remove(); showMessage('Error IA: ' + (err?.message || err), 'error');
          await wait(50);
          // pista √∫til si es 404:
          if ((err?.message||'').includes('Modelo no accesible')) {
            showMessage('Verifica que "models/u2netp.onnx" est√© en la carpeta que publica GitHub Pages (ra√≠z o /docs) y respete may√∫sculas.', 'warning', 6000);
          }
        }
      });
    });
  </script>
</body>
</html>
