<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editor DTF - Montaje para Impresi√≥n</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:#2d3748;line-height:1.6;min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    header{background:linear-gradient(135deg,#2c3e50 0%,#4a5568 100%);color:#fff;padding:1.5rem 2rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .logo{font-size:1.8rem;font-weight:700}
    .logo span{color:#4299e1}
    .specs{background:#4a5568;color:#fff;padding:.8rem 1.5rem;border-radius:8px;font-size:.9rem}
    .main-content{display:flex;padding:1rem;gap:1.5rem;min-height:70vh}
    .toolbar,.controls{width:250px;background:#f8f9fa;border-radius:10px;padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.05)}
    .tool-section{margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid #e9ecef}
    .tool-section:last-child{border-bottom:none}
    .tool-section h3{margin-bottom:1rem;color:#2d3748;font-size:1.1rem}
    .btn{display:block;width:100%;padding:.8rem;margin-bottom:.6rem;border:none;border-radius:6px;background:#4299e1;color:#fff;font-weight:500;cursor:pointer;transition:background .3s;text-align:center}
    .btn:hover{background:#3182ce}
    .btn-upload{background:#48bb78}.btn-upload:hover{background:#38a169}
    .btn-download{background:#9f7aea}.btn-download:hover{background:#805ad5}
    .btn-clear{background:#f56565}.btn-clear:hover{background:#e53e3e}
    .btn-ghost{background:#e2e8f0;color:#2d3748}
    .canvas-container{flex:1;background:#f8f9fa;border-radius:10px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,.05);padding:1rem;display:flex;flex-direction:column}
    .canvas-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .canvas-area{flex:1;background:#fff;border-radius:8px;overflow:auto;display:flex;justify-content:center;align-items:flex-start;padding:1rem;box-shadow:inset 0 0 10px rgba(0,0,0,.05);position:relative}
    #canvas{background:#fff;box-shadow:0 0 20px rgba(0,0,0,.1);touch-action:none;cursor:default}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .size-controls{display:flex;gap:10px;margin-bottom:1rem}
    .size-input{flex:1}
    .size-input input{width:100%;padding:.5rem;border:1px solid #cbd5e0;border-radius:4px;text-align:center}
    input[type="range"],input[type="number"],select{width:100%}
    .size-info{background:#edf2f7;padding:.8rem;border-radius:6px;margin-top:1rem;font-size:.9rem}
    .size-info h4{margin-bottom:.5rem;color:#2d3748}
    .help-section{margin-top:2rem;padding:1rem;background:#edf2f7;border-radius:8px}
    footer{text-align:center;padding:1.5rem;background:#2d3748;color:#fff;margin-top:2rem}
    .instructions{margin-top:1.5rem;padding:1.5rem;background:#edf2f7;border-radius:10px}
    .instructions h3{margin-bottom:1rem;color:#2d3748}
    .instructions ol{padding-left:1.5rem}
    .instructions li{margin-bottom:.8rem}
    .designs-list{max-height:200px;overflow-y:auto;margin-top:1rem;border:1px solid #e2e8f0;border-radius:6px;padding:.5rem}
    .design-item{display:flex;align-items:center;padding:.5rem;margin-bottom:.5rem;background:#fff;border-radius:4px;cursor:pointer;transition:background .2s}
    .design-item:hover{background:#edf2f7}
    .design-item.active{background:#ebf8ff;border:1px solid #90cdf4}
    .design-thumb{width:40px;height:40px;object-fit:cover;border-radius:3px;margin-right:.5rem}
    .proportion-lock{display:flex;align-items:center;margin-bottom:1rem}
    .proportion-lock input{margin-right:.5rem}
    .quality-options{margin-top:1rem}
    .canvas-background{display:flex;align-items:center;gap:10px;margin-bottom:1rem}
    .canvas-background input[type="color"]{width:30px;height:30px;padding:0;border:1px solid #cbd5e0;border-radius:4px;cursor:pointer}
    .message-container{position:fixed;top:20px;right:20px;z-index:1000;max-width:350px}
    .message{padding:12px 16px;margin-bottom:10px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);animation:slideIn .3s ease-out;display:flex;align-items:center}
    .message.info{background:#bee3f8;color:#2c5282;border-left:4px solid #2c5282}
    .message.success{background:#c6f6d5;color:#22543d;border-left:4px solid #22543d}
    .message.error{background:#fed7d7;color:#742a2a;border-left:4px solid #742a2a}
    .message.warning{background:#feebcb;color:#744210;border-left:4px solid #744210}
    .message.loading{background:#e9d8fd;color:#553c9a;border-left:4px solid #553c9a}
    .message-icon{margin-right:10px;font-size:18px}
    .close-message{margin-left:auto;background:none;border:none;font-size:18px;cursor:pointer;opacity:.7}
    .close-message:hover{opacity:1}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
    @media (max-width:1024px){.main-content{flex-wrap:wrap}.toolbar,.controls{width:100%}.message-container{top:10px;right:10px;left:10px;max-width:none}}

    /* Overlay de contrase√±a (solo disuasivo en frontend) */
    .lock-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#2c3e50 0%,#4a5568 100%);display:flex;align-items:center;justify-content:center;z-index:2000;color:#fff}
    .lock-card{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(10px);padding:2rem;border-radius:12px;width:min(90vw,380px)}
    .lock-card h2{margin-bottom:1rem}
    .lock-card input{width:100%;padding:.8rem;border-radius:8px;border:none;margin:.5rem 0 1rem 0}
    .lock-card button{width:100%;padding:.8rem;border:none;border-radius:8px;background:#48bb78;color:#fff;font-weight:600;cursor:pointer}
    .lock-error{color:#fed7d7;min-height:1.2em;margin-bottom:.5rem}
  </style>
</head>
<body>
  <!-- Overlay de contrase√±a -->
  <div class="lock-overlay" id="lock-overlay" style="display:none;">
    <div class="lock-card">
      <h2>Acceso restringido</h2>
      <p>Ingresa la contrase√±a para ver el editor.</p>
      <input type="password" id="lock-pass" placeholder="Contrase√±a" autocomplete="current-password">
      <div class="lock-error" id="lock-error"></div>
      <button id="lock-btn">Acceder</button>
      <p style="opacity:.8;margin-top:.75rem;font-size:.85rem">Nota: En GitHub Pages cualquiera puede ver el c√≥digo, esto es solo una capa visual.</p>
    </div>
  </div>

  <div class="container" id="app-root" style="visibility:hidden;">
    <header>
      <div class="logo">Editor DTF <span>By: David Munive</span></div>
      <div class="specs" id="specs-label">Lienzo: 58cm √ó 100cm | Formato: PNG/PDF</div>
    </header>

    <div class="main-content">
      <!-- Toolbar izquierda -->
      <div class="toolbar">
        <div class="tool-section">
          <h3>Gesti√≥n de Dise√±os</h3>
          <input type="file" id="file-input" accept="image/*" style="display:none" multiple>
          <button class="btn btn-upload" id="upload-btn" aria-label="Subir dise√±os">‚¨ÜÔ∏è Subir Dise√±o(s)</button>
          <button class="btn" id="add-text-btn" title="Agregar texto rasterizado">‚úèÔ∏è Agregar Texto</button>

          <div class="row" style="margin-top:.5rem">
            <button class="btn btn-ghost" id="mirror-btn" title="Espejo horizontal">ü™û Espejo</button>
          </div>
          <div class="grid-2" style="margin-top:.25rem">
            <button class="btn btn-ghost" id="bring-front-btn" title="Traer al frente">üîº Al frente</button>
            <button class="btn btn-ghost" id="send-back-btn" title="Enviar al fondo">üîΩ Al fondo</button>
          </div>
        </div>

        <div class="tool-section">
          <h3>Alinear seleccionado</h3>
          <div class="grid-3">
            <button class="btn" id="align-left"  title="Alinear a la izquierda">‚ü∏ Izq</button>
            <button class="btn" id="align-center-x" title="Centrar horizontal">‚áî Ctr X</button>
            <button class="btn" id="align-right" title="Alinear a la derecha">Der ‚üπ</button>
          </div>
          <div class="grid-3" style="margin-top:8px">
            <button class="btn" id="align-top" title="Alinear arriba">‚ü∞ Arr</button>
            <button class="btn" id="align-center-y" title="Centrar vertical">‚áï Ctr Y</button>
            <button class="btn" id="align-bottom" title="Alinear abajo">Aba ‚ü±</button>
          </div>
          <small style="display:block;margin-top:.5rem;opacity:.8">Usa el √°rea segura (respeta sangrado si est√° activo).</small>
        </div>

        <div class="tool-section">
          <h3>Distribuir todos</h3>
          <div class="grid-2">
            <button class="btn" id="distribute-h" title="Distribuir horizontalmente">‚ÜîÔ∏é Horiz</button>
            <button class="btn" id="distribute-v" title="Distribuir verticalmente">‚ÜïÔ∏é Vert</button>
          </div>
          <small style="display:block;margin-top:.5rem;opacity:.8">Ordena por posici√≥n actual y reparte espacios iguales.</small>
        </div>

        <div class="tool-section">
          <h3>Opciones de Exportaci√≥n</h3>
          <div class="quality-options">
            <label for="quality-select">Resoluci√≥n de exportaci√≥n:</label>
            <select id="quality-select">
              <option value="300">Alta (300 DPI)</option>
              <option value="150" selected>Media (150 DPI)</option>
              <option value="72">Baja (72 DPI)</option>
            </select>
          </div>

          <div class="row" style="margin-top:.75rem">
            <label for="bleed-cm" style="flex:1">Sangrado (cm)</label>
            <input type="number" id="bleed-cm" min="0" step="0.1" value="0.3" inputmode="decimal" style="flex:1" title="Tama√±o de sangrado/seguridad (cm)">
          </div>
          <div class="row" style="align-items:center;margin-top:.5rem">
            <input type="checkbox" id="toggle-bleed" checked style="flex:0 0 auto">
            <label for="toggle-bleed" style="flex:1">Mostrar sangrado</label>
          </div>

          <button class="btn btn-download" id="download-png">üíæ Descargar PNG</button>
          <button class="btn btn-download" id="download-pdf">üìÑ Descargar PDF</button>
          <button class="btn btn-clear" id="clear-btn">üßπ Limpiar Lienzo</button>
        </div>

        <div class="instructions">
          <h3>Instrucciones</h3>
          <ol>
            <li>Sube tus dise√±os con "Subir Dise√±o(s)".</li>
            <li>Selecciona un dise√±o para editarlo.</li>
            <li>Arrastra para mover; usa manejadores para rotar/escalar.</li>
            <li>Alinea el seleccionado o distribuye todos.</li>
            <li>Descarga en PNG o PDF.</li>
          </ol>
          <p class="help-section">
            <strong>Nota:</strong> El fondo es visual (exporta con transparencia).<br>
            Zoom: <kbd>Ctrl</kbd> + rueda. Rotaci√≥n precisa: <kbd>Shift</kbd> (15¬∞).
          </p>
        </div>
      </div>

      <!-- Canvas central -->
      <div class="canvas-container">
        <div class="canvas-title">
          <h3>√Årea de Montaje (<span id="canvas-size-label">58cm √ó 100cm</span>)</h3>
          <div id="zoom-level">Zoom: 100%</div>
        </div>
        <div class="canvas-area">
          <div class="canvas-wrapper" id="canvas-wrapper" style="width:580px;height:1000px;
            background-image:
              linear-gradient(45deg,#f0f0f0 25%,transparent 25%),
              linear-gradient(-45deg,#f0f0f0 25%,transparent 25%),
              linear-gradient(45deg,transparent 75%,#f0f0f0 75%),
              linear-gradient(-45deg,transparent 75%,#f0f0f0 75%);
            background-size:20px 20px;
            background-position:0 0,0 10px,10px -10px,-10px 0px;">
            <canvas id="canvas" width="580" height="1000"></canvas>
          </div>
        </div>
      </div>

      <!-- Panel derecho (controles) -->
      <div class="controls">
        <div class="control-group">
          <h4>Alto del lienzo (cm)</h4>
          <div class="row">
            <input type="number" id="canvas-height-cm" min="10" max="100" step="0.5" value="100" title="Alto en cm (m√°x. 100)" inputmode="decimal">
            <button class="btn" id="apply-canvas-height">Aplicar alto</button>
          </div>
          <small>El ancho permanece en 58 cm. M√°ximo 100 cm de alto.</small>
        </div>

        <div class="control-group">
          <h4>Zoom del Lienzo</h4>
          <div class="row">
            <span id="zoom-value" style="width:60px;text-align:center">100%</span>
            <input type="range" id="zoom-slider" min="20" max="200" value="100" aria-label="Zoom del lienzo">
          </div>
        </div>

        <div class="tool-section">
          <h3>Controles de Dise√±o</h3>

          <div class="control-group">
            <h4>Rotaci√≥n</h4>
            <div class="row">
              <div>
                <div class="row">
                  <span id="rotation-value" style="width:60px;text-align:center">0¬∞</span>
                  <input type="range" id="rotation-slider" min="0" max="360" value="0" aria-label="Rotaci√≥n">
                </div>
              </div>
              <input type="number" id="rotation-input" min="0" max="360" step="1" value="0" title="Rotaci√≥n (¬∞)" inputmode="numeric">
            </div>
          </div>

          <div class="control-group">
            <h4>Opacidad</h4>
            <div class="row">
              <span id="opacity-value" style="width:60px;text-align:center">100%</span>
              <input type="range" id="opacity-slider" min="0" max="100" value="100" aria-label="Opacidad">
            </div>
          </div>

          <div class="control-group">
            <h4>Tama√±o Manual (cm)</h4>
            <div class="proportion-lock">
              <input type="checkbox" id="lock-proportion" checked>
              <label for="lock-proportion">Mantener proporci√≥n</label>
            </div>
            <div class="size-controls">
              <div class="size-input">
                <label>Ancho</label>
                <input type="number" id="width-input" min="0.1" step="0.1" value="0" inputmode="decimal">
              </div>
              <div class="size-input">
                <label>Alto</label>
                <input type="number" id="height-input" min="0.1" step="0.1" value="0" inputmode="decimal">
              </div>
            </div>
            <button class="btn" id="apply-size">Aplicar Tama√±o</button>
          </div>

          <div class="size-info">
            <h4>Dimensiones del dise√±o</h4>
            <div id="size-info">0cm √ó 0cm</div>
            <div id="original-size">Tama√±o original: 0cm √ó 0cm</div>
          </div>

          <button class="btn btn-clear" id="remove-btn">üóëÔ∏è Eliminar Dise√±o</button>
        </div>

        <div class="help-section">
          <h4>Atajos</h4>
          <p>‚Ä¢ Supr/Backspace: eliminar seleccionado</p>
          <p>‚Ä¢ Flechas: mover (Shift = 10 px)</p>
          <p>‚Ä¢ Ctrl/Cmd + D: duplicar seleccionado</p>
          <p>‚Ä¢ Ctrl + rueda: zoom</p>
          <p>‚Ä¢ Shift al rotar: saltos de 15¬∞</p>
        </div>
      </div>
    </div>

    <footer>
      <p>Editor de Montajes para Impresi√≥n DTF</p>
    </footer>
  </div>

  <!-- Mensajes -->
  <div class="message-container" id="message-container"></div>

  <!-- Librer√≠as -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-NA9x+JdI9h7wYtE0v0xFJ4r4PpbK2cX6q3nEbJ8nQh9x1m2qW5mK2pGqYq+v+F8Wm0+7w8Wb6sZzYwqV0b0wAw==" crossorigin="anonymous"></script>

  <script>
    // ====== Seguridad (Contrase√±a) ======
    const ACCESS_PASSWORD = 'dtf2025'; // Solo visual
    const overlay = document.getElementById('lock-overlay');
    const appRoot = document.getElementById('app-root');
    const lockBtn = document.getElementById('lock-btn');
    const lockPass = document.getElementById('lock-pass');
    const lockError = document.getElementById('lock-error');

    function showLock(){ overlay.style.display = 'flex'; appRoot.style.visibility = 'hidden'; setTimeout(()=> lockPass && lockPass.focus(), 0); }
    function unlock(){ overlay.style.display = 'none'; appRoot.style.visibility = 'visible'; }
    if (sessionStorage.getItem('dtf_unlocked') === '1') unlock(); else showLock();
    function tryUnlock(){ if (!lockPass) return; if (lockPass.value === ACCESS_PASSWORD){ sessionStorage.setItem('dtf_unlocked','1'); unlock(); } else { lockError.textContent = 'Contrase√±a incorrecta'; } }
    lockBtn && lockBtn.addEventListener('click', tryUnlock);
    lockPass && lockPass.addEventListener('keydown', e => { if (e.key === 'Enter') tryUnlock(); });

    // ====== Referencias DOM
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const uploadBtn = document.getElementById('upload-btn');
    const fileInput = document.getElementById('file-input');
    const clearBtn = document.getElementById('clear-btn');
    const downloadPngBtn = document.getElementById('download-png');
    const downloadPdfBtn = document.getElementById('download-pdf');
    const rotationSlider = document.getElementById('rotation-slider');
    const rotationValue = document.getElementById('rotation-value');
    const rotationInput = document.getElementById('rotation-input');
    const opacitySlider = document.getElementById('opacity-slider');
    const opacityValue = document.getElementById('opacity-value');
    const zoomSlider = document.getElementById('zoom-slider');
    const zoomValue = document.getElementById('zoom-value');
    const zoomLevel = document.getElementById('zoom-level');
    const addTextBtn = document.getElementById('add-text-btn');
    const designsList = document.getElementById('designs-list');
    const removeBtn = document.getElementById('remove-btn');
    const sizeInfo = document.getElementById('size-info');
    const originalSizeInfo = document.getElementById('original-size');
    const widthInput = document.getElementById('width-input');
    const heightInput = document.getElementById('height-input');
    const applySizeBtn = document.getElementById('apply-size');
    const lockProportion = document.getElementById('lock-proportion');
    const qualitySelect = document.getElementById('quality-select');
    const canvasColor = document.getElementById('canvas-color');
    const messageContainer = document.getElementById('message-container');
    const canvasWrapper = document.getElementById('canvas-wrapper');
    const specsLabel = document.getElementById('specs-label');
    const canvasSizeLabel = document.getElementById('canvas-size-label');
    const canvasHeightInput = document.getElementById('canvas-height-cm');
    const applyCanvasHeightBtn = document.getElementById('apply-canvas-height');
    const bleedInput = document.getElementById('bleed-cm');
    const toggleBleed = document.getElementById('toggle-bleed');
    const mirrorBtn = document.getElementById('mirror-btn');
    const bringFrontBtn = document.getElementById('bring-front-btn');
    const sendBackBtn = document.getElementById('send-back-btn');

    const alignLeftBtn   = document.getElementById('align-left');
    const alignCenterXBtn= document.getElementById('align-center-x');
    const alignRightBtn  = document.getElementById('align-right');
    const alignTopBtn    = document.getElementById('align-top');
    const alignCenterYBtn= document.getElementById('align-center-y');
    const alignBottomBtn = document.getElementById('align-bottom');

    const distributeHBtn = document.getElementById('distribute-h');
    const distributeVBtn = document.getElementById('distribute-v');

    // ====== Constantes f√≠sicas
    const PIXELS_PER_CM = 10; // 10 px = 1 cm
    const CANVAS_WIDTH_CM = 58;
    let CANVAS_HEIGHT_CM = 100;
    const INCHES_PER_CM = 0.3937007874;
    const ROT_SNAP = 15; // grados con Shift

    // ====== Estado
    let designs = [];
    let selectedDesignId = null;
    let isDragging = false;
    let isResizing = false;
    let isRotating = false;
    let dragOffsetX, dragOffsetY;
    let canvasZoom = 1.0;
    let startScale = 1.0;
    let startResizeDist = 1.0;
    let canvasBackgroundColor = '#ffffff';

    // ====== Mensajes
    function showMessage(message, type = 'info', duration = 5000) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      const icons = { info:'‚ÑπÔ∏è', success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', loading:'‚è≥' };
      messageEl.innerHTML = `
        <span class="message-icon">${icons[type] || icons.info}</span>
        <span>${message}</span>
        <button class="close-message" aria-label="Cerrar notificaci√≥n">&times;</button>`;
      messageContainer.appendChild(messageEl);
      const closeBtn = messageEl.querySelector('.close-message');
      function close(){ messageEl.style.animation='slideOut .3s ease-out'; setTimeout(()=> messageEl.remove(), 300); }
      closeBtn && closeBtn.addEventListener('click', close);
      if (duration>0) setTimeout(()=> messageEl && close(), duration);
      return messageEl;
    }

    // ====== √Årea segura (considera sangrado y margen de 5px)
    function getSafeBounds(){
      const bleedCm = (toggleBleed.checked ? Math.max(0, parseFloat(bleedInput.value)||0) : 0);
      const pad = 5; // borde visual interno
      const bleedPx = bleedCm * PIXELS_PER_CM;
      const minX = Math.max(pad, bleedPx);
      const minY = Math.max(pad, bleedPx);
      const maxX = canvas.width  - Math.max(pad, bleedPx);
      const maxY = canvas.height - Math.max(pad, bleedPx);
      return {minX, minY, maxX, maxY};
    }

    // ====== Fondo, patr√≥n, gu√≠as y sangrado
    function drawBleed(){
      if (!toggleBleed.checked) return;
      const cm = Math.max(0, parseFloat(bleedInput.value) || 0);
      const px = cm * PIXELS_PER_CM;
      if (px <= 0) return;
      ctx.save();
      ctx.strokeStyle = '#ed8936';
      ctx.lineWidth = 2;
      ctx.setLineDash([8,4]);
      ctx.strokeRect(px, px, canvas.width-2*px, canvas.height-2*px);
      ctx.restore();
    }

    function initCanvas() {
      ctx.save();
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // patr√≥n de transparencia
      const size = 20;
      ctx.fillStyle = '#f0f0f0';
      for (let y = 0; y < canvas.height; y += size) {
        for (let x = 0; x < canvas.width; x += size) {
          if (((x/size + y/size) % 2) === 0) ctx.fillRect(x, y, size, size);
        }
      }

      // capa de color (solo visual)
      ctx.globalAlpha = 0.7;
      ctx.fillStyle = canvasBackgroundColor;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.globalAlpha = 1.0;

      // borde √°rea de impresi√≥n
      ctx.strokeStyle = '#cbd5e0';
      ctx.lineWidth = 2;
      ctx.setLineDash([5,5]);
      ctx.strokeRect(5,5, canvas.width-10, canvas.height-10);
      ctx.setLineDash([]);

      // sangrado
      drawBleed();

      // texto gu√≠a
      if (designs.length===0){
        ctx.fillStyle = '#e2e8f0';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('BY: DAVID MUNIVE', canvas.width/2, canvas.height/2);
      }
      ctx.restore();
    }

    initCanvas();

    // ====== Clase Design
    class Design {
      constructor(id, image, x, y) {
        this.id = id;
        this.image = image;
        this.x = x || canvas.width/2;
        this.y = y || canvas.height/2;
        this.scale = 1.0;
        this.rotation = 0;
        this.opacity = 1.0;
        this.width = image.width;
        this.height = image.height;
        this.aspectRatio = image.width / image.height;
        this.originalWidth = image.width;
        this.originalHeight = image.height;
      }

      draw() {
        ctx.save();
        ctx.globalAlpha = this.opacity;
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation * Math.PI / 180);
        ctx.scale(this.scale, this.scale);

        const width = this.width;
        const height = this.height;

        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(this.image, -width/2, -height/2, width, height);

        if (this.id === selectedDesignId) {
          ctx.strokeStyle = '#4299e1';
          ctx.lineWidth = 2;
          ctx.strokeRect(-width/2, -height/2, width, height);

          ctx.fillStyle = '#4299e1';
          ctx.beginPath(); ctx.arc(0,0,4,0,Math.PI*2); ctx.fill();

          ctx.fillStyle = '#48bb78';
          ctx.beginPath(); ctx.arc(0, -height/2 - 15, 6, 0, Math.PI*2); ctx.fill();

          ctx.fillStyle = '#f56565';
          ctx.beginPath(); ctx.arc(width/2 + 5, height/2 + 5, 6, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
      }

      getDimensionsInCm() {
        return {
          width:  (this.width  * this.scale) / PIXELS_PER_CM,
          height: (this.height * this.scale) / PIXELS_PER_CM
        };
      }

      getOriginalDimensionsInCm() {
        return {
          width:  (this.originalWidth)  / PIXELS_PER_CM,
          height: (this.originalHeight) / PIXELS_PER_CM
        };
      }

      setDimensions(widthCm, heightCm, maintainProportion = true) {
        const targetWidthPx  = widthCm  * PIXELS_PER_CM;
        const targetHeightPx = heightCm * PIXELS_PER_CM;

        if (maintainProportion) {
          this.scale = targetWidthPx / this.originalWidth;
        } else {
          const scaleX = targetWidthPx  / this.originalWidth;
          const scaleY = targetHeightPx / this.originalHeight;
          this.scale = (scaleX + scaleY) / 2;
        }
        this.updateInputs();
        drawCanvas();
        saveState();
      }

      updateInputs() {
        const d = this.getDimensionsInCm();
        widthInput.value = d.width.toFixed(1);
        heightInput.value = d.height.toFixed(1);
      }

      // Colisiones y handles (en coordenadas post-rotaci√≥n)
      isPointInside(x, y) {
        const width = this.width * this.scale;
        const height = this.height * this.scale;
        const relX = x - this.x, relY = y - this.y;
        const angle = -this.rotation * Math.PI/180;
        const rx = relX * Math.cos(angle) - relY * Math.sin(angle);
        const ry = relX * Math.sin(angle) + relY * Math.cos(angle);
        return Math.abs(rx) <= width/2 && Math.abs(ry) <= height/2;
      }

      isRotationHandle(x, y) {
        const width = this.width * this.scale;
        const height = this.height * this.scale;
        const relX = x - this.x, relY = y - this.y;
        const angle = -this.rotation * Math.PI/180;
        const rx = relX * Math.cos(angle) - relY * Math.sin(angle);
        const ry = relX * Math.sin(angle) + relY * Math.cos(angle);
        const hx = 0, hy = -height/2 - 15;
        return Math.hypot(rx - hx, ry - hy) <= 10;
      }

      isScaleHandle(x, y) {
        const width = this.width * this.scale;
        const height = this.height * this.scale;
        const relX = x - this.x, relY = y - this.y;
        const angle = -this.rotation * Math.PI/180;
        const rx = relX * Math.cos(angle) - relY * Math.sin(angle);
        const ry = relX * Math.sin(angle) + relY * Math.cos(angle);
        const hx = width/2 + 5, hy = height/2 + 5;
        return Math.hypot(rx - hx, ry - hy) <= 10;
      }
    }

    // ====== Dibujo general
    function drawCanvas() {
      initCanvas();
      designs.forEach(d => d.draw());
      updateSizeInfo();
    }

    function updateSizeInfo() {
      const d = getSelectedDesign();
      if (d) {
        const c = d.getDimensionsInCm();
        const o = d.getOriginalDimensionsInCm();
        sizeInfo.textContent = `${c.width.toFixed(1)}cm √ó ${c.height.toFixed(1)}cm`;
        originalSizeInfo.textContent = `Tama√±o original: ${o.width.toFixed(1)}cm √ó ${o.height.toFixed(1)}cm`;
      } else {
        sizeInfo.textContent = '0cm √ó 0cm';
        originalSizeInfo.textContent = 'Tama√±o original: 0cm √ó 0cm';
      }
    }

    // ====== Exportaci√≥n
    function getPixelDimensions(dpi) {
      const widthPx  = Math.round(CANVAS_WIDTH_CM  * INCHES_PER_CM * dpi);
      const heightPx = Math.round(CANVAS_HEIGHT_CM * INCHES_PER_CM * dpi);
      return { width: widthPx, height: heightPx };
    }

    function createHighQualityCanvas() {
      const dpi = parseInt(qualitySelect.value);
      const { width, height } = getPixelDimensions(dpi);

      const exportCanvas = document.createElement('canvas');
      exportCanvas.width = width;
      exportCanvas.height = height;
      const ectx = exportCanvas.getContext('2d', {alpha:true});
      ectx.imageSmoothingEnabled = true;
      ectx.imageSmoothingQuality = 'high';

      const sX = width  / (CANVAS_WIDTH_CM  * PIXELS_PER_CM);
      const sY = height / (CANVAS_HEIGHT_CM * PIXELS_PER_CM);

      designs.forEach(design => {
        ectx.save();
        ectx.globalAlpha = design.opacity;
        ectx.translate(design.x * sX, design.y * sY);
        ectx.rotate(design.rotation * Math.PI/180);
        ectx.scale(design.scale * sX, design.scale * sY);
        ectx.drawImage(design.image, -design.width/2, -design.height/2, design.width, design.height);
        ectx.restore();
      });

      return exportCanvas;
    }

    // ====== Color de fondo (visual)
    canvasColor && canvasColor.addEventListener('input', function(){
      canvasBackgroundColor = this.value;
      drawCanvas();
      showMessage(`Color de fondo cambiado a ${this.value}`, 'info', 2000);
      saveState();
    });

    // ====== Upload con downscale suave
    function downscaleImageIfNeeded(img, maxSide=8000){
      const biggest = Math.max(img.width, img.height);
      if (biggest <= maxSide) return img;
      const ratio = maxSide / biggest;
      const c = document.createElement('canvas');
      c.width = Math.round(img.width * ratio);
      c.height = Math.round(img.height * ratio);
      const cctx = c.getContext('2d', {alpha:true});
      cctx.imageSmoothingEnabled = true;
      cctx.imageSmoothingQuality = 'high';
      cctx.drawImage(img, 0, 0, c.width, c.height);
      const scaled = new Image();
      scaled.src = c.toDataURL('image/png');
      return scaled;
    }

    uploadBtn && uploadBtn.addEventListener('click', ()=>{
      fileInput && (fileInput.value = '');
      fileInput && fileInput.click();
    });

    fileInput && fileInput.addEventListener('change', function(e){
      if (!(e.target.files && e.target.files.length>0)) return;
      const files = Array.from(e.target.files);
      let loaded = 0;
      const total = files.length;
      const loadingMsg = showMessage(`Cargando ${total} dise√±o(s)...`,'loading',0);

      files.forEach(file=>{
        if (!file.type.match('image.*')){
          showMessage(`Error: ${file.name} no es una imagen v√°lida`,'error');
          if (++loaded===total) loadingMsg.remove();
          return;
        }
        const reader = new FileReader();
        reader.onload = function(ev){
          const baseImg = new Image();
          baseImg.onload = function(){
            const img = downscaleImageIfNeeded(baseImg);
            img.onload = function(){
              const id = 'design-' + Date.now() + Math.random().toString(36).slice(2,7);
              const d = new Design(id, img);

              const maxW = canvas.width - 20;
              const maxH = canvas.height - 20;
              const scaleToFit = Math.min(maxW / d.width, maxH / d.height);
              d.scale = Math.min(1, scaleToFit);

              designs.push(d);
              selectedDesignId = id;

              if (++loaded===total) { loadingMsg.remove(); showMessage(`${total} dise√±o(s) cargado(s)`,'success'); }
              updateDesignsList(); updateControls(); drawCanvas(); saveState();
            };
            if (img.complete) img.onload();
          };
          baseImg.onerror = function(){
            if (++loaded===total) loadingMsg.remove();
            showMessage(`Error al cargar la imagen: ${file.name}`,'error');
          }
          baseImg.src = ev.target.result;
        };
        reader.onerror = function(){
          if (++loaded===total) loadingMsg.remove();
          showMessage(`Error al leer: ${file.name}`,'error');
        }
        reader.readAsDataURL(file);
      });

      fileInput.value = '';
    });

    // ====== Lista de dise√±os
    function updateDesignsList(){
      designsList.innerHTML = '';
      if (designs.length===0){
        designsList.innerHTML = '<div class="no-designs">No hay dise√±os cargados</div>';
        return;
      }
      designs.forEach(design=>{
        const item = document.createElement('div');
        item.className = 'design-item' + (design.id===selectedDesignId ? ' active' : '');
        item.dataset.id = design.id;

        const thumbCanvas = document.createElement('canvas');
        thumbCanvas.width = 40; thumbCanvas.height = 40;
        const tctx = thumbCanvas.getContext('2d');
        const scale = Math.min(40/design.width, 40/design.height) * 0.8;
        tctx.fillStyle = '#fff'; tctx.fillRect(0,0,40,40);
        tctx.save();
        tctx.translate(20,20);
        tctx.scale(scale, scale);
        tctx.drawImage(design.image, -design.width/2, -design.height/2, design.width, design.height);
        tctx.restore();
        tctx.strokeStyle = '#cbd5e0'; tctx.strokeRect(0,0,40,40);

        item.innerHTML = `<img class="design-thumb" src="${thumbCanvas.toDataURL('image/png')}" alt="Miniatura"><div>Dise√±o ${designs.indexOf(design)+1}</div>`;
        item.addEventListener('click', ()=>{
          selectedDesignId = design.id;
          updateDesignsList(); updateControls(); drawCanvas();
          showMessage(`Dise√±o ${designs.indexOf(design)+1} seleccionado`,'info',2000);
        });
        designsList.appendChild(item);
      });
    }

    // ====== Controles
    function updateControls(){
      const d = getSelectedDesign();
      const setDisabled = (els, st)=> els.forEach(el=> el.disabled=st);
      if (d){
        rotationSlider.value = Math.round(d.rotation);
        rotationInput.value = Math.round(d.rotation);
        rotationValue.textContent = Math.round(d.rotation) + '¬∞';
        opacitySlider.value = Math.round(d.opacity*100);
        opacityValue.textContent = Math.round(d.opacity*100) + '%';
        d.updateInputs();

        setDisabled([rotationSlider, rotationInput, opacitySlider, removeBtn,
         widthInput, heightInput, applySizeBtn, lockProportion,
         mirrorBtn, bringFrontBtn, sendBackBtn,
         alignLeftBtn, alignCenterXBtn, alignRightBtn, alignTopBtn, alignCenterYBtn, alignBottomBtn], false);

        updateSizeInfo();
      } else {
        setDisabled([rotationSlider, rotationInput, opacitySlider, removeBtn,
         widthInput, heightInput, applySizeBtn, lockProportion,
         mirrorBtn, bringFrontBtn, sendBackBtn,
         alignLeftBtn, alignCenterXBtn, alignRightBtn, alignTopBtn, alignCenterYBtn, alignBottomBtn], true);
        sizeInfo.textContent = '0cm √ó 0cm';
        originalSizeInfo.textContent = 'Tama√±o original: 0cm √ó 0cm';
      }
    }

    function getSelectedDesign(){ return designs.find(d=> d.id===selectedDesignId); }

    // ====== Alinear seleccionado
    function alignSelected(mode){
      const d = getSelectedDesign(); if (!d) return;
      const {minX, minY, maxX, maxY} = getSafeBounds();
      const w = d.width * d.scale;
      const h = d.height* d.scale;

      switch(mode){
        case 'left':   d.x = minX + w/2; break;
        case 'centerX':d.x = (minX + maxX)/2; break;
        case 'right':  d.x = maxX - w/2; break;
        case 'top':    d.y = minY + h/2; break;
        case 'centerY':d.y = (minY + maxY)/2; break;
        case 'bottom': d.y = maxY - h/2; break;
      }
      drawCanvas(); saveState();
    }

    alignLeftBtn   && alignLeftBtn.addEventListener('click', ()=>alignSelected('left'));
    alignCenterXBtn&& alignCenterXBtn.addEventListener('click', ()=>alignSelected('centerX'));
    alignRightBtn  && alignRightBtn.addEventListener('click', ()=>alignSelected('right'));
    alignTopBtn    && alignTopBtn.addEventListener('click', ()=>alignSelected('top'));
    alignCenterYBtn&& alignCenterYBtn.addEventListener('click', ()=>alignSelected('centerY'));
    alignBottomBtn && alignBottomBtn.addEventListener('click', ()=>alignSelected('bottom'));

    // ====== Distribuir todos (respeta bounds y tama√±os actuales)
    function distribute(axis){
      if (designs.length < 2){ showMessage('Necesitas 2 o m√°s dise√±os para distribuir','warning',2500); return; }
      const {minX, minY, maxX, maxY} = getSafeBounds();

      // Copia ordenada por centro
      const arr = designs.slice().sort((a,b)=> (axis==='h' ? a.x-b.x : a.y-b.y));

      if (axis==='h'){
        // total de anchos
        const totalW = arr.reduce((s,d)=> s + d.width * d.scale, 0);
        const available = (maxX - minX) - totalW;
        if (available < 0){ showMessage('No hay espacio horizontal suficiente para distribuir sin solapes','warning',3000); return; }
        const gap = available / (arr.length - 1);

        // posicionar secuencialmente
        let cursor = minX;
        arr.forEach(d=>{
          const w = d.width * d.scale;
          d.x = cursor + w/2;
          cursor += w + gap;
        });
      } else {
        // total de altos
        const totalH = arr.reduce((s,d)=> s + d.height * d.scale, 0);
        const available = (maxY - minY) - totalH;
        if (available < 0){ showMessage('No hay espacio vertical suficiente para distribuir sin solapes','warning',3000); return; }
        const gap = available / (arr.length - 1);

        let cursor = minY;
        arr.forEach(d=>{
          const h = d.height * d.scale;
          d.y = cursor + h/2;
          cursor += h + gap;
        });
      }
      drawCanvas(); saveState();
      showMessage(axis==='h' ? 'Distribuci√≥n horizontal aplicada' : 'Distribuci√≥n vertical aplicada','success',1800);
    }

    distributeHBtn && distributeHBtn.addEventListener('click', ()=>distribute('h'));
    distributeVBtn && distributeVBtn.addEventListener('click', ()=>distribute('v'));

    // ====== Controles de tama√±o/rotaci√≥n/opacidad
    applySizeBtn && applySizeBtn.addEventListener('click', function(){
      const d = getSelectedDesign(); if (!d) return;
      const w = parseFloat(widthInput.value);
      const h = parseFloat(heightInput.value);
      if (!isNaN(w) && !isNaN(h) && w>0 && h>0){
        d.setDimensions(w,h, lockProportion.checked);
        showMessage(`Tama√±o ajustado a ${w}cm √ó ${h}cm`, 'success', 2000);
      }
    });

    lockProportion && lockProportion.addEventListener('change', function(){
      const d = getSelectedDesign();
      if (d && this.checked){
        const w = parseFloat(widthInput.value);
        if (!isNaN(w) && w>0) heightInput.value = (w / d.aspectRatio).toFixed(1);
      }
      showMessage(this.checked ? 'Proporci√≥n bloqueada' : 'Proporci√≥n desbloqueada','info',2000);
    });

    widthInput && widthInput.addEventListener('input', function(){
      if (!lockProportion.checked) return;
      const d = getSelectedDesign(); if (!d) return;
      const w = parseFloat(this.value);
      if (!isNaN(w) && w>0) heightInput.value = (w / d.aspectRatio).toFixed(1);
    });

    heightInput && heightInput.addEventListener('input', function(){
      if (!lockProportion.checked) return;
      const d = getSelectedDesign(); if (!d) return;
      const h = parseFloat(this.value);
      if (!isNaN(h) && h>0) widthInput.value = (h * d.aspectRatio).toFixed(1);
    });

    rotationSlider && rotationSlider.addEventListener('input', function(){
      const d = getSelectedDesign(); if (!d) return;
      let val = parseInt(this.value) || 0;
      d.rotation = val; rotationInput.value = val; rotationValue.textContent = val + '¬∞';
      drawCanvas(); saveState();
    });

    rotationInput && rotationInput.addEventListener('input', function(){
      const d = getSelectedDesign(); if (!d) return;
      let val = parseInt(this.value); if (isNaN(val)) val = 0;
      val = ((val % 360) + 360) % 360;
      d.rotation = val; rotationSlider.value = val; rotationValue.textContent = val + '¬∞';
      drawCanvas(); saveState();
    });

    opacitySlider && opacitySlider.addEventListener('input', function(){
      const d = getSelectedDesign(); if (!d) return;
      d.opacity = this.value / 100; opacityValue.textContent = this.value + '%';
      drawCanvas(); saveState();
    });

    removeBtn && removeBtn.addEventListener('click', function(){
      const d = getSelectedDesign();
      if (d && confirm('¬øEliminar este dise√±o?')){
        designs = designs.filter(x=> x.id!==d.id);
        selectedDesignId = designs.length ? designs[designs.length-1].id : null;
        showMessage('Dise√±o eliminado','info',2000);
        updateDesignsList(); updateControls(); drawCanvas(); saveState();
      }
    });

    // ====== Z-Order
    bringFrontBtn && bringFrontBtn.addEventListener('click', ()=>{
      const d = getSelectedDesign(); if (!d) return;
      designs = designs.filter(x=> x.id!==d.id); designs.push(d);
      updateDesignsList(); drawCanvas(); saveState();
    });
    sendBackBtn && sendBackBtn.addEventListener('click', ()=>{
      const d = getSelectedDesign(); if (!d) return;
      designs = designs.filter(x=> x.id!==d.id); designs.unshift(d);
      updateDesignsList(); drawCanvas(); saveState();
    });

    // ====== Espejo (horizontal)
    mirrorBtn && mirrorBtn.addEventListener('click', ()=>{
      const d = getSelectedDesign(); if (!d) return;
      const tCanvas = document.createElement('canvas');
      tCanvas.width = d.image.width; tCanvas.height = d.image.height;
      const tctx = tCanvas.getContext('2d');
      tctx.translate(tCanvas.width, 0); tctx.scale(-1, 1);
      tctx.drawImage(d.image, 0, 0);
      const img = new Image();
      img.onload = ()=>{ d.image = img; drawCanvas(); saveState(); showMessage('Espejo aplicado','success',1500); };
      img.src = tCanvas.toDataURL('image/png');
    });

    // ====== Zoom slider
    zoomSlider && zoomSlider.addEventListener('input', function(){
      canvasZoom = this.value/100;
      zoomValue.textContent = this.value + '%';
      zoomLevel.textContent = 'Zoom: ' + this.value + '%';

      const canvasContainer = document.querySelector('.canvas-area');
      canvasWrapper.style.transform = `scale(${canvasZoom})`;
      canvasWrapper.style.transformOrigin = 'top center';
      canvasContainer.scrollLeft = (canvas.width * canvasZoom - canvasContainer.clientWidth)/2;
      canvasContainer.scrollTop  = (canvas.height* canvasZoom - canvasContainer.clientHeight)/2;
    });

    // ====== Zoom con rueda (Ctrl + rueda)
    const canvasArea = document.querySelector('.canvas-area');
    canvasArea.addEventListener('wheel', (e)=>{
      if (!e.ctrlKey) return;
      e.preventDefault();
      const zNow = canvasZoom;
      const zNext = Math.max(0.2, Math.min(2, zNow + (e.deltaY<0 ? 0.1 : -0.1)));
      zoomSlider.value = Math.round(zNext*100);
      zoomSlider.dispatchEvent(new Event('input'));
    }, {passive:false});

    // ====== Exportar PNG
    downloadPngBtn && downloadPngBtn.addEventListener('click', function(){
      if (designs.length===0){ showMessage('No hay dise√±os para exportar','error'); return; }
      const loading = showMessage('Preparando descarga PNG...','loading',0);
      setTimeout(()=>{
        try{
          const exportCanvas = createHighQualityCanvas();
          const link = document.createElement('a');
          link.download = 'montaje-dtf.png';
          exportCanvas.toBlob(function(blob){
            link.href = URL.createObjectURL(blob);
            link.click();
            setTimeout(()=>{ URL.revokeObjectURL(link.href); loading.remove(); showMessage('Descarga PNG completada','success'); },100);
          }, 'image/png', 1.0);
        } catch(err){
          loading.remove(); showMessage('Error al generar PNG: ' + err.message, 'error');
        }
      }, 120);
    });

    // ====== Exportar PDF
    downloadPdfBtn && downloadPdfBtn.addEventListener('click', function(){
      if (designs.length===0){ showMessage('No hay dise√±os para exportar','error'); return; }
      const loading = showMessage('Preparando descarga PDF...','loading',0);
      setTimeout(()=>{
        try{
          const exportCanvas = createHighQualityCanvas();
          exportCanvas.toBlob(function(blob){
            const reader = new FileReader();
            reader.onload = function(){
              const imgData = reader.result;
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [CANVAS_WIDTH_CM*10, CANVAS_HEIGHT_CM*10]
              });
              doc.addImage(imgData, 'PNG', 0, 0, CANVAS_WIDTH_CM*10, CANVAS_HEIGHT_CM*10, undefined, 'FAST');
              doc.save('montaje-dtf.pdf');
              loading.remove(); showMessage('Descarga PDF completada','success');
            };
            reader.readAsDataURL(blob);
          }, 'image/png', 1.0);
        } catch(err){
          loading.remove(); showMessage('Error al generar PDF: ' + err.message, 'error');
        }
      }, 120);
    });

    // ====== Limpiar lienzo
    clearBtn && clearBtn.addEventListener('click', function(){
      if (designs.length>0 && confirm('¬øLimpiar el lienzo? Se perder√°n todos los dise√±os.')){
        designs = []; selectedDesignId = null;
        showMessage('Lienzo limpiado','info',2000);
        updateDesignsList(); updateControls(); initCanvas(); saveState();
      }
    });

    // ====== Interacci√≥n mouse/touch
    function toCanvasCoords(e){
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top)  * scaleY };
    }

    function quantizeRotation(angle){ return Math.round(angle / ROT_SNAP) * ROT_SNAP; }

    canvas.addEventListener('mousedown', function(e){
      const {x, y} = toCanvasCoords(e);

      for (let i=designs.length-1; i>=0; i--){
        const d = designs[i];

        if (d.isRotationHandle(x,y)){
          selectedDesignId = d.id; isRotating = true;
          updateDesignsList(); updateControls(); drawCanvas(); return;
        }
        if (d.isScaleHandle(x,y)){
          selectedDesignId = d.id; isResizing = true;
          startScale = d.scale;
          startResizeDist = Math.hypot(x - d.x, y - d.y);
          updateDesignsList(); updateControls(); drawCanvas(); return;
        }
        if (d.isPointInside(x,y)){
          selectedDesignId = d.id; isDragging = true;
          dragOffsetX = x - d.x; dragOffsetY = y - d.y;
          updateDesignsList(); updateControls(); drawCanvas(); return;
        }
      }
      selectedDesignId = null;
      updateDesignsList(); updateControls(); drawCanvas();
    });

    canvas.addEventListener('mousemove', function(e){
      const {x, y} = toCanvasCoords(e);
      const d = getSelectedDesign(); if (!d) return;

      if (isDragging){
        d.x = x - dragOffsetX; d.y = y - dragOffsetY;
        drawCanvas(); saveState();
      } else if (isRotating){
        let angle = Math.atan2(y - d.y, x - d.x) * 180 / Math.PI + 90;
        angle = (angle % 360 + 360) % 360;
        if (e.shiftKey) angle = quantizeRotation(angle);
        d.rotation = angle;
        rotationSlider.value = Math.round(angle);
        rotationInput.value = Math.round(angle);
        rotationValue.textContent = Math.round(angle) + '¬∞';
        drawCanvas(); saveState();
      } else if (isResizing){
        const dist = Math.hypot(x - d.x, y - d.y);
        const factor = dist / Math.max(1, startResizeDist);
        d.scale = Math.max(0.01, startScale * factor);
        d.updateInputs(); updateSizeInfo();
        drawCanvas(); saveState();
      }
    });

    ['mouseup','mouseleave'].forEach(ev=>{
      canvas.addEventListener(ev, function(){ isDragging = false; isResizing = false; isRotating = false; });
    });

    // touch
    canvas.addEventListener('touchstart', function(e){
      e.preventDefault();
      const t = e.touches[0];
      canvas.dispatchEvent(new MouseEvent('mousedown', { clientX:t.clientX, clientY:t.clientY }));
    }, {passive:false});
    canvas.addEventListener('touchmove', function(e){
      e.preventDefault();
      const t = e.touches[0];
      canvas.dispatchEvent(new MouseEvent('mousemove', { clientX:t.clientX, clientY:t.clientY }));
    }, {passive:false});
    canvas.addEventListener('touchend', function(e){
      e.preventDefault();
      canvas.dispatchEvent(new MouseEvent('mouseup', {}));
    }, {passive:false});

    // ====== Alto del lienzo
    applyCanvasHeightBtn && applyCanvasHeightBtn.addEventListener('click', function(){
      let newHcm = parseFloat(canvasHeightInput.value);
      if (isNaN(newHcm)) return;
      newHcm = Math.max(10, Math.min(100, newHcm));
      CANVAS_HEIGHT_CM = newHcm;

      const newPx = Math.round(CANVAS_HEIGHT_CM * PIXELS_PER_CM);
      canvas.height = newPx;
      canvasWrapper.style.height = newPx + 'px';

      canvasSizeLabel.textContent = `${CANVAS_WIDTH_CM}cm √ó ${CANVAS_HEIGHT_CM}cm`;
      specsLabel.textContent = `Lienzo: ${CANVAS_WIDTH_CM}cm √ó ${CANVAS_HEIGHT_CM}cm | Formato: PNG/PDF`;

      drawCanvas();
      showMessage(`Alto del lienzo ajustado a ${CANVAS_HEIGHT_CM} cm`, 'success', 2000);
      saveState();
    });

    // ====== Atajos
    document.addEventListener('keydown', function(e){
      const tag = (e.target.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea') return;

      const d = getSelectedDesign();
      const step = e.shiftKey ? 10 : 1;

      // Eliminar
      if ((e.key === 'Delete' || e.key === 'Backspace') && d){
        e.preventDefault();
        designs = designs.filter(x=> x.id!==d.id);
        selectedDesignId = designs.length ? designs[designs.length-1].id : null;
        updateDesignsList(); updateControls(); drawCanvas();
        showMessage('Dise√±o eliminado','info',1500);
        saveState();
        return;
      }

      if (!d) return;

      // Duplicar
      if ((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 'd')){
        e.preventDefault();
        const id = 'design-' + Date.now() + Math.random().toString(36).slice(2,7);
        const dup = new Design(id, d.image, d.x + 10, d.y + 10);
        dup.scale = d.scale; dup.rotation = d.rotation; dup.opacity = d.opacity;
        designs.push(dup);
        selectedDesignId = id;
        updateDesignsList(); updateControls(); drawCanvas();
        showMessage('Dise√±o duplicado','success',1200);
        saveState();
        return;
      }

      // Mover con flechas
      const arrows = ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'];
      if (arrows.includes(e.key)){
        e.preventDefault();
        if (e.key === 'ArrowLeft')  d.x -= step;
        if (e.key === 'ArrowRight') d.x += step;
        if (e.key === 'ArrowUp')    d.y -= step;
        if (e.key === 'ArrowDown')  d.y += step;
        drawCanvas(); saveState();
      }
    });

    // ====== Persistencia
    function saveState(){
      try {
        const state = {
          CANVAS_HEIGHT_CM,
          canvasBackgroundColor,
          bleedCm: parseFloat(bleedInput.value) || 0.3,
          showBleed: toggleBleed.checked,
          designs: designs.map(d=>({
            id:d.id,x:d.x,y:d.y,scale:d.scale,rotation:d.rotation,opacity:d.opacity,
            src:d.image.src, w:d.width, h:d.height
          })),
          selectedId: selectedDesignId
        };
        localStorage.setItem('dtf_state', JSON.stringify(state));
      } catch(e){}
    }

    function loadState(){
      try {
        const raw = localStorage.getItem('dtf_state'); if (!raw) return;
        const st = JSON.parse(raw);
        CANVAS_HEIGHT_CM = st.CANVAS_HEIGHT_CM || CANVAS_HEIGHT_CM;
        canvasBackgroundColor = st.canvasBackgroundColor || canvasBackgroundColor;
        if (typeof st.bleedCm === 'number') bleedInput.value = st.bleedCm.toFixed(1);
        if (typeof st.showBleed === 'boolean') toggleBleed.checked = st.showBleed;

        const newPx = Math.round(CANVAS_HEIGHT_CM * PIXELS_PER_CM);
        canvas.height = newPx;
        canvasWrapper.style.height = newPx + 'px';
        canvasSizeLabel.textContent = `${CANVAS_WIDTH_CM}cm √ó ${CANVAS_HEIGHT_CM}cm`;
        specsLabel.textContent = `Lienzo: ${CANVAS_WIDTH_CM}cm √ó ${CANVAS_HEIGHT_CM}cm | Formato: PNG/PDF`;
        canvasColor.value = canvasBackgroundColor;

        designs = [];
        const arr = st.designs || [];
        let remain = arr.length;
        if (remain === 0){ drawCanvas(); updateDesignsList(); updateControls(); return; }

        arr.forEach(o=>{
          const img = new Image();
          img.onload = ()=>{
            const d = new Design(o.id, img, o.x, o.y);
            d.scale=o.scale; d.rotation=o.rotation; d.opacity=o.opacity; d.width=o.w; d.height=o.h;
            d.aspectRatio = d.width / d.height;
            designs.push(d);
            remain--;
            if (remain===0){
              selectedDesignId = st.selectedId || (designs[0] && designs[0].id) || null;
              updateDesignsList(); updateControls(); drawCanvas();
            }
          };
          img.src = o.src;
        });
      } catch(e){ localStorage.removeItem('dtf_state'); }
    }

    ['input','click','change'].forEach(ev=>document.addEventListener(ev, ()=>{ saveState(); }, {passive:true}));
    loadState();

    // ====== Iniciar
    updateControls();
    setTimeout(()=> showMessage('¬°Bienvenido al Editor DTF! Sube tus dise√±os para comenzar.','info'), 800);
  </script>
</body>
</html>
